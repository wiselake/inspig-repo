# 로그 테이블 참조 문서

운영 대시보드에서 사용하는 로그 테이블 정의

---

## 1. TA_KAKAOMSG_SENT (카카오/SMS 발송 로그)

카카오 알림톡 및 SMS 발송 이력 저장

### 테이블 구조

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| ID | NUMBER | PK, 일련번호 |
| CREATEDAT | DATE | 전송시간 |
| UPDATEDAT | DATE | 전송결과검증시간 |
| SCHEDULEDAT | DATE | 스케줄예약시간 |
| TO_TEL | VARCHAR2(20) | 수신번호 |
| FROM_TEL | VARCHAR2(20) | 발신번호 |
| GROUPID | VARCHAR2(255) | Solapi 그룹ID |
| MESSAGEID | VARCHAR2(255) | Solapi 메시지ID |
| STATUS | VARCHAR2(20) | 전송결과 (SENDING, SUCCESS, FAILED 등) |
| STATUSCODE | VARCHAR2(255) | 전송결과코드 (2000:정상접수, 3000:이통사접수, 4000:수신완료) |
| STATUSMESSAGE | VARCHAR2(4000) | 전송결과메시지 |
| PAYLOAD | CLOB (JSON) | 전송내용 |
| RESULT | CLOB (JSON) | 전송결과내용 |
| SENT | VARCHAR2(1) | 발송여부 (0/1) |
| CERTIFIED_KEY | VARCHAR2(10) | 인증번호 |
| CERTIFIED_OK | VARCHAR2(1) | 버튼 인증확인 |
| FARM_NO | NUMBER | 농장번호 |
| MSG_GB | VARCHAR2(20) | 메시지구분 |

### MSG_GB 코드

| 코드 | 설명 |
|------|------|
| GRADE | 등급판정 알림 |
| INSPIG_WEEK | 인사이트피그 주간 리포트 |

### STATUSCODE (Solapi)

| 코드 | 설명 |
|------|------|
| 2000 | 정상접수 |
| 3000 | 이통사접수 |
| 4000 | 수신완료 |

### 인덱스

```sql
CREATE UNIQUE INDEX PK_TA_KAKAOMSG_SENT ON TA_KAKAOMSG_SENT(ID);
CREATE INDEX IDX_TA_KAKAOMSG_SENT_01 ON TA_KAKAOMSG_SENT(GROUPID, MESSAGEID);
CREATE INDEX IDX_TA_KAKAOMSG_SENT_02 ON TA_KAKAOMSG_SENT(MESSAGEID);
CREATE INDEX IDX_TA_KAKAOMSG_SENT_03 ON TA_KAKAOMSG_SENT(MSG_GB, CREATEDAT, FARM_NO);
```

---

## 2. API_LOG (API 호출 로그)

시스템 API 호출 이력 저장

### 테이블 구조

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| LOG_ID | NUMBER(19) | PK, 로그ID |
| REQUEST_TIME | TIMESTAMP(6) | 요청시간 |
| RESPONSE_TIME | TIMESTAMP(6) | 응답시간 |
| DURATION | NUMBER(19) | 소요시간(ms) |
| METHOD | VARCHAR2(10) | HTTP 메소드 (GET, POST 등) |
| URI | VARCHAR2(500) | 요청 URI |
| QUERY_STRING | CLOB | 쿼리 스트링 |
| CLIENT_IP | VARCHAR2(50) | 클라이언트 IP |
| USER_AGENT | VARCHAR2(500) | 사용자 에이전트 |
| REQUEST_HEADERS | CLOB | 요청 헤더 |
| STATUS_CODE | NUMBER(10) | HTTP 상태코드 |
| ERROR_MESSAGE | CLOB | 에러 메시지 |
| EXTRA_INFO | CLOB | 추가 정보 |

### 인덱스

```sql
CREATE INDEX IDX_API_LOG_REQ_TIME ON API_LOG(REQUEST_TIME);
CREATE INDEX IDX_API_LOG_STATUS ON API_LOG(STATUS_CODE);
CREATE INDEX IDX_API_LOG_URI ON API_LOG(URI);
```

---

## 3. TA_LOGIN_LOG (사용자 로그인 로그)

시스템 로그인 이력 저장

### 테이블 구조

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| MEMBER_ID | VARCHAR2(40) | PK, 회원ID |
| LOGIN_SDT | TIMESTAMP(6) | PK, 로그인 시작시간 |
| SYS_TYPE_CD | VARCHAR2(8) | 시스템타입코드 (WEB, MOBILE 등) |
| YEAR | VARCHAR2(4) | 년도 |
| MONTH | VARCHAR2(2) | 월 |
| LOGIN_DT | DATE | 로그인 일시 |
| COMPANY_CD | INTEGER | 업체코드 |
| FARM_NO | INTEGER | 농장번호 |
| IP_ADDRESS | VARCHAR2(20) | 접속 IP |

### 인덱스

```sql
CREATE UNIQUE INDEX IDX_TA_LOGIN_LOG ON TA_LOGIN_LOG(MEMBER_ID, LOGIN_SDT);
CREATE INDEX IDX_TA_LOGIN_LOG_01 ON TA_LOGIN_LOG(COMPANY_CD, FARM_NO, YEAR, MONTH);
CREATE INDEX IDX_TA_LOGIN_LOG_02 ON TA_LOGIN_LOG(YEAR, MONTH);
```

---

## 4. TA_MENU_LOGIN_LOG (메뉴 접속 로그)

메뉴별 접속 이력 저장

### 테이블 구조

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| MEMBER_ID | VARCHAR2(40) | PK, 회원ID |
| LOGIN_SDT | TIMESTAMP(6) | PK, 로그인 시작시간 |
| NO_MENU | VARCHAR2(9) | PK, 메뉴번호 |
| YEAR | VARCHAR2(4) | 년도 |
| MONTH | VARCHAR2(2) | 월 |
| MENU_RTCD | VARCHAR2(9) | 메뉴 결과코드 |
| SYS_TYPE_CD | VARCHAR2(8) | 시스템타입코드 |
| IP_ADDRESS | VARCHAR2(20) | 접속 IP |
| LOG_INS_DT | DATE | 생성일 |

### 인덱스

```sql
CREATE UNIQUE INDEX IDX_TA_MENU_LOGIN_LOG ON TA_MENU_LOGIN_LOG(MEMBER_ID, LOGIN_SDT, NO_MENU);
```

---

---

## 5. InsightPig 전용 로그

ETL 작업 로그(`TS_INS_JOB_LOG`) 및 접속 로그(`TS_INS_ACCESS_LOG`)는 아래 문서를 참조하십시오.

- [INS 테이블 설계 및 정의](../../db/ins/02.table.md)

---

## 대시보드 쿼리 예시

### ETL 현황

```sql
-- 오늘 ETL 실행 요약
SELECT
    STATUS_CD,
    COUNT(*) AS CNT,
    ROUND(AVG(ELAPSED_MS), 0) AS AVG_MS
FROM TS_INS_JOB_LOG
WHERE START_DT >= TRUNC(SYSDATE)
GROUP BY STATUS_CD;

-- 최근 ETL 로그 (최신 50건)
SELECT
    SEQ, JOB_NM, PROC_NM, FARM_NO, DAY_GB,
    TO_CHAR(START_DT, 'HH24:MI:SS') AS START_TIME,
    TO_CHAR(END_DT, 'HH24:MI:SS') AS END_TIME,
    ELAPSED_MS, PROC_CNT, STATUS_CD,
    ERROR_CD, ERROR_MSG
FROM TS_INS_JOB_LOG
WHERE START_DT >= TRUNC(SYSDATE)
ORDER BY SEQ DESC
FETCH FIRST 50 ROWS ONLY;

-- 시간대별 ETL 실행 현황
SELECT
    TO_CHAR(START_DT, 'HH24') AS HOUR,
    COUNT(CASE WHEN STATUS_CD = 'SUCCESS' THEN 1 END) AS SUCCESS_CNT,
    COUNT(CASE WHEN STATUS_CD = 'ERROR' THEN 1 END) AS ERROR_CNT
FROM TS_INS_JOB_LOG
WHERE START_DT >= TRUNC(SYSDATE)
GROUP BY TO_CHAR(START_DT, 'HH24')
ORDER BY HOUR;
```

### 사용자 접속 현황

```sql
-- 오늘 접속자 수
SELECT COUNT(DISTINCT MEMBER_ID) AS TODAY_USERS
FROM TA_LOGIN_LOG
WHERE LOGIN_DT >= TRUNC(SYSDATE);

-- 시간대별 접속 현황
SELECT
    TO_CHAR(LOGIN_SDT, 'HH24') AS HOUR,
    COUNT(DISTINCT MEMBER_ID) AS USER_CNT
FROM TA_LOGIN_LOG
WHERE LOGIN_DT >= TRUNC(SYSDATE)
GROUP BY TO_CHAR(LOGIN_SDT, 'HH24')
ORDER BY HOUR;

-- 최근 로그인 현황
SELECT
    L.MEMBER_ID,
    M.USER_NM,
    F.FARM_NM,
    TO_CHAR(L.LOGIN_SDT, 'HH24:MI:SS') AS LOGIN_TIME,
    L.IP_ADDRESS,
    L.SYS_TYPE_CD
FROM TA_LOGIN_LOG L
LEFT JOIN TA_MEMBER M ON M.MEMBER_ID = L.MEMBER_ID
LEFT JOIN TA_FARM F ON F.FARM_NO = L.FARM_NO
WHERE L.LOGIN_DT >= TRUNC(SYSDATE)
ORDER BY L.LOGIN_SDT DESC
FETCH FIRST 50 ROWS ONLY;

-- 메뉴별 접속 현황
SELECT
    M.NO_MENU,
    MN.MENU_NM,
    COUNT(*) AS ACCESS_CNT
FROM TA_MENU_LOGIN_LOG M
LEFT JOIN TA_MENU MN ON MN.NO_MENU = M.NO_MENU
WHERE M.LOG_INS_DT >= TRUNC(SYSDATE)
GROUP BY M.NO_MENU, MN.MENU_NM
ORDER BY ACCESS_CNT DESC;
```

### SMS/알림톡 발송 현황

```sql
-- 오늘 발송 요약
SELECT
    MSG_GB,
    COUNT(*) AS TOTAL_CNT,
    COUNT(CASE WHEN STATUSCODE = '4000' THEN 1 END) AS SUCCESS_CNT,
    COUNT(CASE WHEN STATUSCODE NOT IN ('2000', '3000', '4000') OR STATUSCODE IS NULL THEN 1 END) AS FAIL_CNT
FROM TA_KAKAOMSG_SENT
WHERE CREATEDAT >= TRUNC(SYSDATE)
GROUP BY MSG_GB;

-- 최근 발송 내역
SELECT
    ID,
    TO_CHAR(CREATEDAT, 'YYYY-MM-DD HH24:MI:SS') AS SEND_TIME,
    FARM_NO,
    SUBSTR(TO_TEL, 1, 3) || '-****-' || SUBSTR(TO_TEL, -4) AS TO_TEL_MASK,
    MSG_GB,
    STATUSCODE,
    STATUS,
    STATUSMESSAGE
FROM TA_KAKAOMSG_SENT
WHERE CREATEDAT >= TRUNC(SYSDATE) - 7
ORDER BY CREATEDAT DESC
FETCH FIRST 50 ROWS ONLY;

-- 일별 발송 현황 (최근 7일)
SELECT
    TO_CHAR(CREATEDAT, 'YYYY-MM-DD') AS SEND_DATE,
    COUNT(*) AS TOTAL_CNT,
    COUNT(CASE WHEN STATUSCODE = '4000' THEN 1 END) AS SUCCESS_CNT
FROM TA_KAKAOMSG_SENT
WHERE CREATEDAT >= TRUNC(SYSDATE) - 7
GROUP BY TO_CHAR(CREATEDAT, 'YYYY-MM-DD')
ORDER BY SEND_DATE;

-- 발송 실패 상세
SELECT
    ID, CREATEDAT, FARM_NO, TO_TEL, MSG_GB,
    STATUSCODE, STATUSMESSAGE, RESULT
FROM TA_KAKAOMSG_SENT
WHERE CREATEDAT >= TRUNC(SYSDATE) - 7
  AND (STATUSCODE NOT IN ('2000', '3000', '4000') OR STATUSCODE IS NULL)
ORDER BY CREATEDAT DESC;
```

### API 호출 현황

```sql
-- 오늘 API 호출 요약
SELECT
    COUNT(*) AS TOTAL_CNT,
    COUNT(CASE WHEN STATUS_CODE = 200 THEN 1 END) AS SUCCESS_CNT,
    COUNT(CASE WHEN STATUS_CODE >= 400 THEN 1 END) AS ERROR_CNT,
    ROUND(AVG(DURATION), 0) AS AVG_DURATION_MS
FROM API_LOG
WHERE REQUEST_TIME >= TRUNC(SYSDATE);

-- URI별 호출 현황
SELECT
    URI,
    COUNT(*) AS CALL_CNT,
    ROUND(AVG(DURATION), 0) AS AVG_MS,
    COUNT(CASE WHEN STATUS_CODE >= 400 THEN 1 END) AS ERROR_CNT
FROM API_LOG
WHERE REQUEST_TIME >= TRUNC(SYSDATE)
GROUP BY URI
ORDER BY CALL_CNT DESC
FETCH FIRST 20 ROWS ONLY;

-- 에러 API 로그
SELECT
    LOG_ID, REQUEST_TIME, METHOD, URI,
    STATUS_CODE, DURATION, ERROR_MESSAGE
FROM API_LOG
WHERE REQUEST_TIME >= TRUNC(SYSDATE)
  AND STATUS_CODE >= 400
ORDER BY REQUEST_TIME DESC
FETCH FIRST 50 ROWS ONLY;
```

---

## 데이터 보관 정책

| 테이블 | 보관 기간 | 삭제 주기 |
|--------|----------|----------|
| TS_INS_JOB_LOG | 6개월 | 일별 배치 |
| TA_LOGIN_LOG | 1년 | 월별 배치 |
| TA_MENU_LOGIN_LOG | 6개월 | 월별 배치 |
| TA_KAKAOMSG_SENT | 1년 | 월별 배치 |
| API_LOG | 3개월 | 주별 배치 |

```sql
-- 예시: TS_INS_JOB_LOG 6개월 이전 데이터 삭제
DELETE FROM TS_INS_JOB_LOG
WHERE START_DT < ADD_MONTHS(TRUNC(SYSDATE), -6);

-- 예시: TA_KAKAOMSG_SENT 1년 이전 데이터 삭제
DELETE FROM TA_KAKAOMSG_SENT
WHERE CREATEDAT < ADD_MONTHS(TRUNC(SYSDATE), -12);
```
