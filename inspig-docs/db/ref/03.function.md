# 운영 함수 참조

> 기존 운영 DB 함수 정보 요약

---

## SF_GET_MODONGB_STATUS

모돈 상태코드/상태명 반환 함수

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| P_CALL_GB | VARCHAR2 | 호출구분: 'CD'=상태코드, 'NM'=상태명 |
| P_WK_GUBUN | VARCHAR2 | 작업구분 (A/G/B/E/F) |
| P_SAGO_GUBUN_CD | VARCHAR2 | 사고구분코드 (050002=유산) |
| P_OUT_DT | DATE | 출고일 |
| P_IN_STATUS_CD | VARCHAR2 | 전입 상태코드 |
| P_DAERI_YN | VARCHAR2 | 대리모 여부 |
| P_LANG | VARCHAR2 | 언어코드 (ko/en/vi) |

### 반환값

| 작업구분 | 조건 | 반환 상태코드 |
|----------|------|---------------|
| - | OUT_DT != 9999-12-31 | 010008 (도폐사돈) |
| G (교배) | - | 010002 (임신돈) |
| B (분만) | - | 010003 (포유돈) |
| E (이유) | DAERI_YN = 'N' | 010005 (이유모돈) |
| E (이유) | DAERI_YN = 'Y' | 010004 (대리모돈) |
| F (사고) | SAGO_GUBUN_CD = '050002' | 010007 (유산돈) |
| F (사고) | SAGO_GUBUN_CD != '050002' | 010006 (재발돈) |
| 기타 | - | 010001 (후보돈) |

### 사용 예시

```sql
-- 상태코드 반환
SELECT SF_GET_MODONGB_STATUS('CD', 'G', NULL,
       TO_DATE('99991231', 'YYYYMMDD'), '010002', 'N', '')
FROM DUAL;
-- 결과: 010002 (임신돈)

-- 상태명 반환 (한국어)
SELECT SF_GET_MODONGB_STATUS('NM', 'B', NULL,
       TO_DATE('99991231', 'YYYYMMDD'), '010003', 'N', 'ko')
FROM DUAL;
-- 결과: 포유돈
```

---

## SF_GET_LOCALE_VW_DATE_2022

타임존 변환 함수 (다국어 지원)

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| LOCALE | VARCHAR2 | 로케일 (KOR/VNM) |
| IN_DATE | DATE | 입력일자 |

### 지원 로케일

| 로케일 | 타임존 |
|--------|--------|
| KOR | UTC+9 |
| VNM | UTC+7 |

---

## FN_LOC_MAX_ONE_2020

특정일 기준 모돈의 마지막 장소 조회 함수

### 용도

- 특정일 기준 모돈의 마지막 장소명 반환
- FN_MD_SCHEDULE_BSE_2020에서 LOC_NM 조회 시 사용

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| P_FARM_NO | INTEGER | 농장번호 |
| P_PIG_NO | INTEGER | 돼지번호 |
| P_WK_DT | VARCHAR2 | 기준일 (yyyy-MM-dd) |
| P_DATE_FORMAT | VARCHAR2 | 날짜포맷 (미사용) |

### 반환값

`VARCHAR2(200)` - 장소명 (TC_LOC.LOC_NM)

### 장소 조회 우선순위

3개 테이블에서 UNION ALL 후 마지막 작업일 기준:

| 순서 | 테이블 | 조건 |
|------|--------|------|
| 1 | TB_MODON | IN_LOC_CD > 0 (전입장소) |
| 2 | TB_MODON_WK | LOC_CD > 0 (작업장소) |
| 3 | TB_MD_LOC_TRANS | LOC_CD > 0 (장소이동) |

### 핵심 로직

```sql
MAX(LOC_CD) KEEP (DENSE_RANK LAST ORDER BY WK_DT, LOG_INS_DT)
-- 동일 날짜 내 가장 마지막 등록된 장소
```

### 사용 예시

```sql
SELECT FN_LOC_MAX_ONE_2020(1456, 12345, '2024-12-15', 'yyyy-MM-dd')
FROM DUAL;
-- 결과: '분만사 1동'
```

### 성능 고려사항

- 모돈별 1건씩 호출 → 대량 조회 시 성능 저하
- 예정돈 대장에서는 NULL 반환 후 별도 조회 권장

---

## SF_WEEK_CNT2

주차 계산 함수 (일요일/월요일 기준)

### 용도

- 특정일의 년도 내 주차 계산
- FN_MD_SCHEDULE_BSE_2020에서 AUTO_GRP 계산 시 사용

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| SDATE | VARCHAR2 | 날짜 (yyyy-MM-dd) |
| STYPE | VARCHAR2 | 기준요일 (NULL/'SU'=일요일, 그 외=월요일) |

### 반환값

`NUMBER` - 주차 (0부터 시작)

### 계산 로직

```sql
-- 일요일 기준 (STYPE = 'SU' 또는 NULL)
TRUNC((TRUNC(날짜) - TRUNC(TRUNC(날짜, 'YY'), 'D')) / 7)

-- 월요일 기준
TRUNC((TRUNC(날짜) - TRUNC(TRUNC(날짜, 'YY'), 'IW')) / 7)
```

### 사용 예시

```sql
-- 일요일 기준 주차
SELECT SF_WEEK_CNT2('2024-12-15', NULL) FROM DUAL;  -- 결과: 50

-- 월요일 기준 주차 (IW)
SELECT SF_WEEK_CNT2('2024-12-15', 'MO') FROM DUAL;  -- 결과: 50
```

### 대체 방법 (V2에서)

```sql
-- SF_WEEK_CNT2 대신 TO_CHAR 사용 가능
TO_CHAR(WK_DATE, 'IW')  -- ISO 주차 (월요일 기준)
LEAST(TO_CHAR(WK_DATE, 'IW'), 52)  -- 53주차는 52로 처리
```

---

## FN_MD_SCHEDULE_BSE_2020

예정돈 조회 핵심 함수 (Pipelined Table Function)

### 용도

- 작업예정돈 대장/달력 조회
- 각 예정작업별 대상 모돈 목록 반환
- ETL ScheduleProcessor에서 사용

### 파라미터

| 파라미터 | 타입 | 설명 |
|----------|------|------|
| P_FARM_NO | INTEGER | 농장번호 |
| P_REPORT_GB | VARCHAR2 | JOB-DAJANG: 대장, JOB-CALENDAR: 달력 |
| P_SCHEDULE_GB | VARCHAR2 | 150001:임신진단, 150002:분만, 150003:이유, 150004:백신, 150005:교배, 150004:백신2 |
| P_STATUS_CODE | VARCHAR2 | 모돈상태 필터 (NULL=전체) |
| P_SDT | VARCHAR2 | 조회시작일 (yyyy-MM-dd) |
| P_EDT | VARCHAR2 | 조회종료일 (yyyy-MM-dd) |
| P_MDGRP | INTEGER | 모돈그룹 (호환용) |
| P_LANG | VARCHAR2 | 언어코드 (ko/en/vi) |
| P_DATE_FORMAT | VARCHAR2 | 날짜포맷 (기본: yyyy-MM-dd) |
| P_SEQ | VARCHAR2 | 예정작업 SEQ (-1=전체, 콤마구분) |
| P_SANCHA | VARCHAR2 | 산차범위 (FROM,TO) |

### 반환 타입 (TYPE_MD_SCHEDULE_BSE)

| 컬럼 | 설명 |
|------|------|
| FARM_NO | 농장번호 |
| PIG_NO | 시스템번호 |
| FARM_PIG_NO | 개체번호 |
| IGAK_NO | 이각번호 |
| WK_NM | 예정작업명 |
| AUTO_GRP | 자동그룹 (yy-주차) |
| LOC_NM | 장소명 |
| SANCHA | 산차 |
| GYOBAE_CNT | 교배차수 |
| LAST_WK_DT | 마지막 작업일 |
| PASS_DAY | 경과일수 |
| PASS_DT | 예정일 |
| LAST_WK_NM | 마지막 작업명 |
| LAST_WK_GUBUN | 마지막 작업구분 |
| LAST_WK_GUBUN_CD | 마지막 작업구분코드 |
| ARTICLE_NM | 백신명 (백신예정시) |
| HCODE | 백신코드 |
| DAERI_YN | 대리모여부 |

### 핵심 로직

```sql
-- 1. MODON_BASE: VW_MODON_2020_MAX_WK_02 인라인 대체
--    TB_MODON LEFT JOIN (마지막 작업정보)
--    STATUS_CODE 계산: SF_GET_MODONGB_STATUS 호출

-- 2. JOB_TBL: 예정작업별 대상 모돈상태 매핑
--    150005 (교배): 010001(후보), 010005(이유), 010006(재발), 010007(유산)
--    150002 (분만): 010002(임신)
--    150003 (이유): 010003(포유), 010004(대리)
--    150001 (진단): 010002(임신)

-- 3. TB_PLAN_MODON 조인: 농장별 예정작업 설정
--    STD_CD 기준 예정일 계산:
--    - 020002 (전입): IN_DT + PASS_DAY
--    - 020003 (교배): LAST_WK_DT + PASS_DAY
--    - 020004 (분만): LAST_WK_DT + PASS_DAY
--    - 020005 (이유): LAST_WK_DT + PASS_DAY
```

### 사용 예시

```sql
-- 분만 예정돈 조회 (금주)
SELECT * FROM TABLE(FN_MD_SCHEDULE_BSE_2020(
    1456,                    -- 농장번호
    'JOB-DAJANG',           -- 대장
    '150002',               -- 분만예정
    NULL,                   -- 전체 상태
    '2024-12-16',           -- 시작일
    '2024-12-22',           -- 종료일
    NULL,                   -- 모돈그룹
    'ko',                   -- 한국어
    'yyyy-MM-dd',           -- 날짜포맷
    '-1',                   -- 전체 SEQ
    NULL                    -- 산차범위
));

-- 교배 대기돈 조회
SELECT * FROM TABLE(FN_MD_SCHEDULE_BSE_2020(
    1456, 'JOB-DAJANG', '150005', NULL,
    '2024-12-16', '2024-12-22', NULL, 'ko', 'yyyy-MM-dd', '-1', NULL
));
```

### ETL에서 호출

```python
# ScheduleProcessor에서 예정돈 조회
sql = """
SELECT COUNT(*)
FROM TABLE(FN_MD_SCHEDULE_BSE_2020(
    :farm_no, 'JOB-DAJANG', :schedule_gb, NULL,
    :sdt, :edt, NULL, 'ko', 'yyyy-MM-dd', '-1', NULL
))
"""
result = self.fetch_one(sql, {
    'farm_no': self.farm_no,
    'schedule_gb': '150002',  # 분만예정
    'sdt': '2024-12-16',
    'edt': '2024-12-22'
})
```

### 성능 고려사항

- VW_MODON_2020_MAX_WK_02 뷰 대신 인라인 서브쿼리 + 힌트 사용
- `/*+ LEADING(TM) USE_HASH(LW) */` 힌트로 TB_MODON 드라이빙
- FN_LOC_MAX_ONE_2020 호출로 대량 조회 시 성능 저하 가능

---

## TC_CODE_SYS 코드 참조

> ETL에서 사용하는 시스템 공통코드

### PCODE 01: 모돈 상태

| CODE | 한국어 | 영어 | 베트남어 |
|------|--------|------|----------|
| 010001 | 후보돈 | Reserve Pig | heo hậu bị |
| 010002 | 임신돈 | Pregnant sow | heo mang thai |
| 010003 | 포유돈 | Lactating Sow | heo đang cho con bú |
| 010004 | 대리모돈 | Surrogate Sow | heo cho bu thay |
| 010005 | 이유모돈 | Weaning Sow | heo nái cai sữa |
| 010006 | 재발돈(사고) | Accident Sow | heo nái động dục trở lại |
| 010007 | 유산돈(사고) | Miscarried sow | heo sẩy thai |
| 010008 | 도폐사돈 | Dead Culled Pig | heo chết loại thải |

### PCODE 02: 작업구분

| CODE | 한국어 | 영어 | 베트남어 |
|------|--------|------|----------|
| 020001 | 출생 | Birth | sinh ra |
| 020002 | 전입 | Transfer-in | chuyển vào |
| 020003 | 교배 | breeding | thụ tinh |
| 020004 | 분만 | farrow | đẻ |
| 020005 | 이유 | Weaning | cho bu |
| 020006 | 대리포유 | Surrogate Lactation | cho bú hộ |
| 020007 | 재발불임 | Recurrent infertility | tai vo sinh |
| 020008 | 유산 | Miscarriage | sẩy thai |
| 020097 | 재교배 | - | - |
| 020098 | 도폐사/판매 | - | - |
| 020099 | 사고 | Accident | sự cố |

### PCODE 05: 임신사고 구분

| CODE | 한국어 | 영어 | 베트남어 | 비고 |
|------|--------|------|----------|------|
| 050001 | (구)재발불임 | Recurrent infertility | tai vo sinh | 레거시 |
| 050002 | 유산 | Miscarriage | sẩy thai | **ETL 주요 사용** |
| 050003 | 도태 | Culling | thải loại | → 080001 |
| 050004 | 폐사 | Death | chết | → 080002 |
| 050005 | 임돈전출 | Pregsow Move out | số lượng heo chửa chuyển đi | → 080003 |
| 050006 | 임돈판매 | Pregsow Sale | ban heo nai | → 080004 |
| 050007 | 공태 | Non-preg | không có thai | |
| 050008 | 재발 | - | - | **ETL 주요 사용** |
| 050009 | 불임 | - | - | |

### PCODE 08: 도폐사 구분

| CODE | 한국어 | 영어 | 베트남어 | 연계코드 |
|------|--------|------|----------|----------|
| 080001 | 도태 | Culling | thải loại | 050003 |
| 080002 | 폐사 | Death | chết | 050004 |
| 080003 | 전출 | Transfer-out | chuyển đi | 050005 |
| 080004 | 판매 | Sale | ban | 050006 |

### PCODE 15: 예정작업 유형

| CODE | 한국어 | 영어 | 베트남어 | 리포트ID |
|------|--------|------|----------|----------|
| 150001 | 임신 감정돈(진단) | Pregnant Test Pig | heo giám định mang thai | RpdWorkScheduleModon03 |
| 150002 | 분만 예정돈 | To be farrowing | heo chờ đẻ | RpdWorkScheduleModon04 |
| 150003 | 이유 예정돈 | To be weaned | heo chờ cai sữa | RpdWorkScheduleModon05 |
| 150004 | 백신 예정돈 | To be vaccinated | heo dự kiến tiêm vắc xin | RpdWorkScheduleModon06 |
| 150005 | 교배 대기돈 | breed schedule | heo chờ phối giống | RpdWorkScheduleModon01 |
| 150006 | 이유예정 자돈 | To be weaned piglet | heo con sự kiến cai sữa | |
| 150007 | 백신예정 자돈 | To be vaccinated piglet | heo con dự kiến tim vắc xin | RpdWorkScheduleModon07 |

### PCODE 16: 포유자돈 구분

| CODE | 한국어 | 영어 | 베트남어 | 용도 |
|------|--------|------|----------|------|
| 160001 | 포유자돈폐사 | Born dead | heo con chết khi cho bú | 폐사 두수 |
| 160002 | 부분이유 | Partial weaning | cai sữa từng phần | |
| 160003 | 양자전입 | Foster | chuyển vào nuôi hộ | 전입 두수 |
| 160004 | 양자전출 | Adopt out | chuyển đi bú nhờ | 전출 두수 |

### ETL에서 주로 사용하는 코드

```sql
-- 모돈 상태 판정 (SF_GET_MODONGB_STATUS 로직)
CASE
    WHEN OUT_DT != TO_DATE('99991231','YYYYMMDD') THEN '010008'  -- 도폐사돈
    WHEN WK_GUBUN = 'G' THEN '010002'  -- 임신돈
    WHEN WK_GUBUN = 'B' THEN '010003'  -- 포유돈
    WHEN WK_GUBUN = 'E' AND DAERI_YN = 'N' THEN '010005'  -- 이유모돈
    WHEN WK_GUBUN = 'E' AND DAERI_YN = 'Y' THEN '010004'  -- 대리모돈
    WHEN WK_GUBUN = 'F' AND SAGO_GUBUN_CD = '050002' THEN '010007'  -- 유산돈
    WHEN WK_GUBUN = 'F' THEN '010006'  -- 재발돈
    ELSE '010001'  -- 후보돈
END AS STATUS_CODE

-- 포유개시 계산 (분만 팝업)
-- 실산 - 폐사(160001) + 전입(160003) - 전출(160004)
NVL(B.SILSAN, 0)
  - SUM(CASE WHEN JT.GUBUN_CD = '160001' THEN NVL(JT.DUSU,0)+NVL(JT.DUSU_SU,0) ELSE 0 END)
  + SUM(CASE WHEN JT.GUBUN_CD = '160003' THEN NVL(JT.DUSU,0)+NVL(JT.DUSU_SU,0) ELSE 0 END)
  - SUM(CASE WHEN JT.GUBUN_CD = '160004' THEN NVL(JT.DUSU,0)+NVL(JT.DUSU_SU,0) ELSE 0 END)
```

