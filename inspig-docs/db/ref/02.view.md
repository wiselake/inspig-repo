# 운영 뷰 참조

> 기존 운영 DB 뷰 정보 요약

---

## VW_MODON_DATE_2020_MAX_WK

모돈별 마지막 작업 기준 현황 뷰

### 용도

- 기준일 기준 모돈의 마지막 작업 정보 조회
- 산차별 x 상태별 모돈 현황 집계

### 주요 컬럼

| 컬럼명 | 설명 |
|--------|------|
| FARM_NO | 농장번호 |
| PIG_NO | 돼지번호 |
| IN_DT | 전입일 |
| OUT_DT | 출고일 |
| WK_GUBUN | 마지막 작업구분 |
| SANCHA | 현재 산차 |
| STATUS_CODE | 상태코드 |

### 사용 방법

```sql
-- 기준일 설정 (필수)
EXEC DBMS_SESSION.SET_IDENTIFIER('2024-12-08');

-- 조회
SELECT * FROM VW_MODON_DATE_2020_MAX_WK
WHERE FARM_NO = 1456
  AND IN_DT <= TO_DATE('2024-12-08', 'YYYY-MM-DD')
  AND OUT_DT > TO_DATE('2024-12-08', 'YYYY-MM-DD');
```

### 특징

- `SYS_CONTEXT('USERENV', 'CLIENT_INFO')`로 기준일 설정
- 작업이력 없는 전입 모돈도 포함
- 임신돈 -> 후보돈 자동 전환 (전입 시 산차=0, 교배차수=1)

---

## VM_MODON_INFO_2020

모돈 상세정보 뷰 (코드명 포함)

### 용도

- 모돈 마스터 + 코드명 조회
- 예정돈 조회 시 모돈 상세정보 제공
- FN_MD_SCHEDULE_BSE_2020 함수에서 사용

### 주요 컬럼

| 컬럼명 | 설명 |
|--------|------|
| FARM_NO | 농장번호 |
| PIG_NO | 돼지번호 |
| FARM_PIG_NO | 개체번호 (농장 입력값) |
| IGAK_NO | 이각번호 |
| PUMJONG_NM | 품종명 (TC_CODE_JOHAP.041) |
| PUMJONG_CD | 품종코드 |
| BIRTH_DT | 생년월일 |
| IN_DT | 전입일 |
| IN_SANCHA | 전입 산차 |
| IN_GYOBAE_CNT | 전입 교배차수 |
| IN_KG | 전입 체중 |
| STATUS_CD | 상태코드 |
| IN_STATUS_NM | 상태명 (TC_CODE_SYS.01) |
| LAST_WK_DT | 마지막 작업일 |
| OUT_DT | 출고일 |
| OUT_GUBUN_NM | 도폐사구분명 (TC_CODE_SYS.08) |
| OUT_REASON_NM | 도폐사사유명 (TC_CODE_JOHAP.031) |
| RFID_NO | RFID 번호 |
| BUY_COM_NM | 구매처명 |
| SALE_COM_NM | 판매처명 |

### 조인 테이블

| 테이블 | 용도 | PCODE |
|--------|------|-------|
| TC_CODE_JOHAP | 품종 | 041 |
| TC_CODE_JOHAP | 가계 | 23 |
| TC_CODE_SYS | 도폐사구분 | 08 |
| TC_CODE_JOHAP | 도폐사사유 | 031 |
| TC_FARM_COMP | 구매처/판매처 | - |
| TC_CODE_SYS | 상태명 | 01 |

### 사용 방법

```sql
-- 언어 설정 (필수)
EXEC DBMS_SESSION.SET_IDENTIFIER('ko');

-- 조회
SELECT FARM_NO, PIG_NO, FARM_PIG_NO, PUMJONG_NM, STATUS_CD, IN_STATUS_NM
FROM VM_MODON_INFO_2020
WHERE FARM_NO = 1456
  AND OUT_DT = '99991231';  -- 재적 모돈
```

### 성능 고려사항

- 10개 이상 LEFT JOIN → 대량 조회 시 성능 저하
- 예정돈 조회 시 필요 컬럼만 TB_MODON 직접 조회 권장
- 코드명 필요시만 뷰 사용

---

## VW_MODON_2020_MAX_WK_02

모돈별 마지막 작업 정보 뷰 (FN_MD_SCHEDULE_BSE_2020 핵심 뷰)

### 용도

- 모돈의 마지막 작업 정보 조회
- 예정돈 조회 함수(FN_MD_SCHEDULE_BSE_2020)에서 사용
- 작업이력 없는 모돈도 전입 정보로 포함

### 주요 컬럼

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| FARM_NO | INTEGER | 농장번호 |
| PIG_NO | INTEGER | 시스템번호 |
| EKAPE_SOW_NO | VARCHAR2 | 축평원 모돈 식별번호 |
| FARM_PIG_NO | VARCHAR2 | 개체번호 |
| IGAK_NO | VARCHAR2 | 이각번호 |
| IN_DT | DATE | 전입일 |
| BIRTH_DT | DATE | 출생일 |
| IN_SANCHA | INTEGER | 전입 산차 |
| IN_GYOBAE_CNT | INTEGER | 전입 교배차수 |
| IN_STATUS_CODE | VARCHAR2 | 전입 상태코드 |
| OUT_DT | DATE | 도폐사일 |
| LAST_WK_DT | DATE | 마지막 작업일 (NVL: WK_DATE → LAST_WK_DT → IN_DT) |
| SEQ | INTEGER | 작업 일련번호 (없으면 0) |
| WK_DT | CHAR(8) | 작업일자 YYYYMMDD |
| WK_DATE | DATE | 작업일 |
| WK_GUBUN | CHAR(1) | 작업구분 (없으면 'A'=전입) |
| WK_GUBUN_CD | VARCHAR2 | 작업구분 코드 (SF_GET_MODON_JOB) |
| SAGO_GUBUN_CD | VARCHAR2 | 사고구분코드 |
| DAERI_YN | CHAR(1) | 대리모여부 |
| SANCHA | INTEGER | 산차 (NVL: WK.SANCHA → IN_SANCHA) |
| GYOBAE_CNT | INTEGER | 교배차수 (NVL: WK.GYOBAE_CNT → IN_GYOBAE_CNT) |
| STATUS_CODE | VARCHAR2 | 현재 상태코드 (SF_GET_MODONGB_STATUS) |
| FULL_STATUS_CODE | VARCHAR2 | 전체 상태코드 (도폐사 포함) |
| LOC_CD | INTEGER | 장소코드 |
| FW_NO | INTEGER | 분만틀번호 |
| F_CNT | INTEGER | 사고(F) 횟수 |
| WK_YN | CHAR(1) | 작업이력 존재여부 (Y/N) |
| RFID_NO | VARCHAR2 | RFID 번호 |

### 핵심 로직

```sql
-- TB_MODON LEFT JOIN (마지막 작업정보)
FROM TB_MODON TM
LEFT OUTER JOIN (
    -- MAX(SEQ)로 마지막 작업 추출
    SELECT WK.FARM_NO, WK.PIG_NO, WK_DT, WK_GUBUN, WK_DATE, ...
    FROM (
        SELECT FARM_NO, PIG_NO, MAX(SEQ) AS MAX_SEQ,
               SUM(CASE WHEN WK_GUBUN = 'F' THEN 1 ELSE 0 END) AS F_CNT
        FROM TB_MODON_WK
        WHERE USE_YN = 'Y'
        GROUP BY FARM_NO, PIG_NO
    ) MK
    INNER JOIN TB_MODON_WK WK
        ON WK.FARM_NO = MK.FARM_NO
       AND WK.PIG_NO = MK.PIG_NO
       AND WK.SEQ = MK.MAX_SEQ
       AND WK.USE_YN = 'Y'
) WK ON TM.FARM_NO = WK.FARM_NO AND TM.PIG_NO = WK.PIG_NO
WHERE USE_YN = 'Y';
```

### 상태코드 변환 로직

| 조건 | 결과 |
|------|------|
| 작업이력 없음 + IN_SANCHA=0 + IN_GYOBAE_CNT=1 + 임신돈 | → 후보돈 (010001) |
| 작업이력 없음 | → TB_MODON.STATUS_CD 유지 |
| 작업이력 있음 | → SF_GET_MODONGB_STATUS() 함수 호출 |

### 사용 예시

```sql
-- 재적 모돈의 마지막 작업 정보 조회
SELECT FARM_NO, PIG_NO, FARM_PIG_NO,
       WK_GUBUN, SANCHA, GYOBAE_CNT, STATUS_CODE, WK_YN
FROM VW_MODON_2020_MAX_WK_02
WHERE FARM_NO = 1456
  AND OUT_DT = TO_DATE('9999-12-31', 'yyyy-MM-dd');

-- 작업이력 없는 모돈 조회
SELECT * FROM VW_MODON_2020_MAX_WK_02
WHERE FARM_NO = 1456 AND WK_YN = 'N';
```

### FN_MD_SCHEDULE_BSE_2020에서 사용

- 예정작업별 대상 모돈 필터링
- WK_YN = 'Y': 마지막 작업일 기준 예정일 계산
- WK_YN = 'N': 출생일/전입일 기준 예정일 계산

---

## 참고

> INS 프로시저에서는 이 뷰를 사용하지 않고 최적화된 인라인 쿼리로 대체함
> (TB_MODON 드라이빙 + TB_MODON_WK LEFT JOIN)
