# INS 테이블 설계

> inspig 주간/월간/분기 리포트용 테이블 구조 및 관계

---

## 1. 테이블 구조

```
┌──────────────────────────────────────┐     ┌─────────────────────────────────────┐
│         TS_INS_SERVICE               │     │          TS_INS_MASTER              │
│  - 서비스 신청 농장 (이력 관리)        │     │  - 주/월별 리포트 생성 기준 정보     │
│  - PK: FARM_NO + INSPIG_REG_DT       │     │  - 대상수, 완료수, 생성상태          │
│  - FK → TA_FARM                      │     │                                     │
└────────────────┬─────────────────────┘     └──────────────────┬──────────────────┘
                 │ 1:N                                          │ 1:N (DAY_GB별 분기)
             │         ┌─────────────────────────────┤
             │         │                             │
             ▼         ▼                             ▼
┌─────────────────────────────┐  ┌──────────────┐  ┌──────────────┐
│      TS_INS_WEEK (주간)      │  │ TS_INS_MON   │  │  TS_INS_QT   │
│  - PK: (MASTER_SEQ, FARM_NO) │  │   (월간)     │  │   (분기)     │
│  - FK: MASTER_SEQ            │  │   [추후]     │  │   [추후]     │
│  - FK: FARM_NO               │  └──────────────┘  └──────────────┘
└─────────────────────────┬───┘
                          │ 1:N
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  TS_INS_WEEK_SUB (상세)                       │
│  - 각 팝업별 리스트 데이터 (주간/월간/분기 공용)               │
│  - GUBUN으로 데이터 유형 구분                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 테이블 분류

### INS 핵심 테이블 (02_TABLE.sql)

| 테이블명 | 설명 | 비고 |
|----------|------|------|
| TA_SYS_CONFIG | 시스템 설정 | 1 row, 전반 설정 |
| TS_INS_SERVICE | 서비스 신청 | FK → TA_FARM |
| TS_INS_MASTER | 리포트 마스터 | 주/월/분기 생성 기준 |
| TS_INS_JOB_LOG | 실행 로그 | 프로시저 상태/오류 |
| TS_INS_WEEK | 주간 리포트 | 농장별 요약 데이터 |
| TS_INS_WEEK_SUB | 상세 데이터 | 팝업별 리스트 |
| TS_INS_MGMT | 관리포인트 | 하이라이트, 추천 |
| TS_INS_ACCESS_LOG | 접속 로그 | 로그인/메뉴/보고서 |
| TS_INS_CONF | 농장별 설정 | 주간보고서 산정방식 (JSON) |

### 공통/ETC 테이블 (03_TABLE_ETC.sql)

| 테이블명 | 설명 | 비고 |
|----------|------|------|
| TM_WEATHER | 날씨 | 기상청 API 데이터 |
| TS_PSY_DELAY_HEATMAP | PSY 히트맵 | 농장 분포 |

---

## 3. 주요 설계 사항

### TS_INS_MASTER - 중복 방지

- UK: `(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO)`
- 동일 년도+주차/월/분기에 1회만 생성

### TS_INS_WEEK_SUB - GUBUN/SUB_GUBUN 코드

**키 구조**: `PK(MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO)`

| GUBUN | SUB_GUBUN | 설명 |
|-------|-----------|------|
| MODON | - | 모돈현황 산차별×상태별 |
| ALERT | - | 관리대상 기간별 |
| ALERT | LIST | 관리대상 모돈목록 |
| GB | STAT | 교배 요약 |
| GB | CHART | 재귀일별 차트 |
| BM | - | 분만 요약 |
| EU | - | 이유 요약 |
| SG | STAT | 임신사고 원인별 |
| SG | CHART | 임신일별 차트 |
| DOPE | STAT | 도태폐사 유형별 |
| DOPE | LIST | 원인별 목록 |
| DOPE | CHART | 상태별 차트 |
| SHIP | STAT | 출하 요약 |
| SHIP | ROW | 크로스탭 행 |
| SHIP | CHART | 분석 차트 |
| SHIP | SCATTER | 산점도 |
| SCHEDULE | - | 예정 요약 |
| SCHEDULE | CAL | 캘린더 행 |
| SCHEDULE | GB | 교배예정 목록 |
| SCHEDULE | BM | 분만예정 목록 |
| SCHEDULE | EU | 이유예정 목록 |
| SCHEDULE | VACCINE | 백신예정 목록 |

> 상세 규칙: [03.procedure-rules.md](./03.procedure-rules.md)

### TS_INS_ACCESS_LOG - 메뉴코드 규칙

8자리: `XX000000`
- 1-2자리: WY(주간), MY(월간), QY(분기), ST(설정)
- 3-4자리: 1차 메뉴 (01~99)
- 5-6자리: 2차 메뉴 (01~99)
- 7-8자리: 3차 메뉴 (01~99)

---

## 4. 테이블 상세 정의

### TA_SYS_CONFIG (시스템 설정)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| SEQ | NUMBER | PK | 일련번호 (항상 1) |
| MODON_HIST_YN | VARCHAR2(1) | | 모돈이력제 연계여부 (Y/N) |
| EKAPE_YN | VARCHAR2(1) | | 축평원 연계여부 (Y/N) |
| INS_SCHEDULE_YN | VARCHAR2(1) | | 인사이트피그플랜 스케줄 실행여부 (Y/N) |
| LOG_INS_DT | DATE | | 생성일 (UTC) |
| LOG_UPT_DT | DATE | | 수정일 (UTC) |

---

### TS_INS_SERVICE (서비스 신청)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| FARM_NO | INTEGER | PK, FK | 농장번호 (TA_FARM 참조) |
| INSPIG_YN | VARCHAR2(1) | | 서비스 신청여부 (Y/N) |
| INSPIG_REG_DT | VARCHAR2(8) | PK | 서비스 신청일 (YYYYMMDD) |
| INSPIG_FROM_DT | VARCHAR2(8) | | 서비스 시작일 (YYYYMMDD) |
| INSPIG_TO_DT | VARCHAR2(8) | | 서비스 종료일 (YYYYMMDD) |
| INSPIG_STOP_DT | VARCHAR2(8) | | 서비스 중단일 (YYYYMMDD) |
| WEB_PAY_YN | VARCHAR2(1) | | 웹결재 여부 (Y/N) |
| REG_TYPE | VARCHAR2(10) | | 등록유형: AUTO(정기), MANUAL(수동) |
| USE_YN | VARCHAR2(1) | | 사용여부 (Y/N) |
| BIGO | VARCHAR2(500) | | 비고 |
| SCHEDULE_GROUP_WEEK | VARCHAR2(10) | | 주간리포트 알림톡 발송 시간대 그룹 (AM7/PM2) |
| SCHEDULE_GROUP_MONTH | VARCHAR2(10) | | 월간리포트 알림톡 발송 시간대 그룹 (AM7/PM2) |
| SCHEDULE_GROUP_QUARTER | VARCHAR2(10) | | 분기리포트 알림톡 발송 시간대 그룹 (AM7/PM2) |
| LOG_INS_DT | DATE | | 생성일 (UTC) |
| LOG_UPT_DT | DATE | | 수정일 (UTC) |

**스케줄 그룹별 발송 시간 (KST):**

| 그룹 | ETL 실행 | 알림톡 발송 |
|------|---------|------------|
| AM7 | 월요일 02:00 | 월요일 07:00 |
| PM2 | 월요일 12:00 | 월요일 14:00 |

---

### TS_INS_MASTER (리포트 마스터)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| SEQ | NUMBER | PK | 일련번호 (시퀀스) |
| DAY_GB | VARCHAR2(10) | NOT NULL | 기간구분 (WEEK, MON, QT) |
| INS_DT | CHAR(8) | NOT NULL | 생성기준일 (YYYYMMDD) |
| REPORT_YEAR | NUMBER(4) | NOT NULL | 년도 |
| REPORT_WEEK_NO | NUMBER(2) | NOT NULL | 주차 (1~53) / 월 (1~12) |
| DT_FROM | VARCHAR2(8) | NOT NULL | 리포트 시작일 (YYYYMMDD) |
| DT_TO | VARCHAR2(8) | NOT NULL | 리포트 종료일 (YYYYMMDD) |
| TARGET_CNT | INTEGER | | 대상 농장수 |
| COMPLETE_CNT | INTEGER | | 실행완료 농장수 |
| ERROR_CNT | INTEGER | | 오류 농장수 |
| STATUS_CD | VARCHAR2(10) | | 상태 (READY, RUNNING, COMPLETE, ERROR) |
| START_DT | DATE | | 실행 시작일시 |
| END_DT | DATE | | 실행 종료일시 |
| ELAPSED_SEC | INTEGER | | 실행 소요시간(초) |

---

### TS_INS_WEEK (주간 리포트 요약)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| MASTER_SEQ | NUMBER | PK, FK | 마스터 일련번호 |
| FARM_NO | INTEGER | PK, FK | 농장번호 |
| REPORT_YEAR | NUMBER(4) | | 년도 |
| REPORT_WEEK_NO | NUMBER(2) | | 주차 |
| DT_FROM | VARCHAR2(8) | | 시작일 (YYYYMMDD) |
| DT_TO | VARCHAR2(8) | | 종료일 (YYYYMMDD) |
| MODON_REG_CNT | INTEGER | | 현재모돈(등록모돈수) |
| MODON_REG_CHG | INTEGER | | 현재모돈 증감 (전주 대비) |
| MODON_SANGSI_CNT | NUMBER | | 상시모돈수 |
| MODON_SANGSI_CHG | NUMBER | | 상시모돈 증감 (전주 대비) |
| KPI_PSY | NUMBER | | PSY |
| KPI_DELAY_DAY | INTEGER | | 입력지연일 |
| STATUS_CD | VARCHAR2(10) | | 상태 (READY, RUNNING, COMPLETE, ERROR) |
| SHARE_TOKEN | VARCHAR2(64) | | 공유용 토큰 (SHA256) |
| TOKEN_EXPIRE_DT | VARCHAR2(8) | | 토큰 만료일 (YYYYMMDD) |
| SCHEDULE_GROUP | VARCHAR2(10) | | ETL 시점 알림톡 발송 그룹 스냅샷 (AM7/PM2) |

> **참고**: `TS_INS_WEEK`에는 위 컬럼 외에도 각 프로세서에서 계산한 `LAST_*`, `THIS_*` 등 다수의 통계 컬럼이 포함되어 있습니다.

**SCHEDULE_GROUP 컬럼 설명:**
- ETL 실행 시점에 `TS_INS_SERVICE.SCHEDULE_GROUP_WEEK` 값을 스냅샷으로 저장
- 알림톡 발송 시 이 값 기준으로 AM7/PM2 그룹 필터링
- ETL 시점과 발송 시점 사이에 설정 변경되어도 정확한 발송 보장

---

### TS_INS_WEEK_SUB (리포트 상세/팝업)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| MASTER_SEQ | NUMBER | PK, FK | 마스터 일련번호 |
| FARM_NO | INTEGER | PK, FK | 농장번호 |
| GUBUN | VARCHAR2(20) | PK | 데이터 구분 (MODON, GB, BM, EU, SG, DOPE, SHIP, SCHEDULE) |
| SUB_GUBUN | VARCHAR2(20) | PK | 세부 구분 (STAT, LIST, CHART, ROW) |
| SORT_NO | INTEGER | PK | 정렬순서 |
| CODE_1 | VARCHAR2(30) | | 1차 구분코드 |
| CODE_2 | VARCHAR2(30) | | 2차 구분코드 |
| CNT_1~15 | NUMBER | | 숫자형 데이터 (두수, 합계 등) |
| VAL_1~15 | NUMBER | | 수치형 데이터 (평균, 비율 등) |
| STR_1~15 | VARCHAR2(1000)| | 문자형 데이터 (라벨, 명칭 등) |

---

### TS_INS_MGMT (관리포인트)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| SEQ | NUMBER | PK | 일련번호 |
| MGMT_TYPE | VARCHAR2(20) | NOT NULL | 유형 (QUIZ, HIGHLIGHT, RECOMMEND) |
| SORT_NO | INTEGER | | 정렬순서 |
| TITLE | VARCHAR2(200) | NOT NULL | 제목 |
| CONTENT | VARCHAR2(4000)| | 상세 내용 |
| LINK_URL | VARCHAR2(500) | | 링크 URL |
| LINK_TARGET | VARCHAR2(10) | | 링크 열기 방식 (POPUP/DIRECT) |
| POST_FROM | DATE | | 게시 시작일 |
| POST_TO | DATE | | 게시 종료일 |
| USE_YN | CHAR(1) | | 사용여부 (Y/N) |

---

### TS_INS_ACCESS_LOG (접속 로그)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| SEQ | NUMBER | PK | 일련번호 |
| MEMBER_ID | VARCHAR2(40) | NOT NULL | 회원ID |
| FARM_NO | INTEGER | NOT NULL | 농장번호 |
| LOG_TYPE | VARCHAR2(20) | NOT NULL | 로그유형 (LOGIN, LOGOUT, MENU, REPORT) |
| MENU_CD | VARCHAR2(50) | | 메뉴코드 (WY/MY/QY/ST...) |
| REPORT_GB | VARCHAR2(10) | | 보고서구분 (WEEK, MON, QT) |
| REPORT_SEQ | NUMBER | | 보고서 일련번호 (MASTER_SEQ) |
| ACCESS_GB | VARCHAR2(10) | | 접속경로 (LIST, LINK, DIRECT) |
| IP_ADDRESS | VARCHAR2(45) | | IP 주소 |
| DEVICE_TYPE | VARCHAR2(20) | | 디바이스 (PC, MOBILE, TABLET) |
| ACCESS_DT | TIMESTAMP | | 접속일시 |

---

### TS_INS_JOB_LOG (ETL 실행 로그)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| SEQ | NUMBER | PK | 일련번호 |
| MASTER_SEQ | NUMBER | | 마스터 일련번호 |
| JOB_NM | VARCHAR2(50) | NOT NULL | JOB 이름 |
| PROC_NM | VARCHAR2(50) | NOT NULL | 프로시저명 |
| FARM_NO | INTEGER | | 농장번호 |
| DAY_GB | VARCHAR2(10) | | 기간구분 (WEEK, MON, QT) |
| STATUS_CD | VARCHAR2(10) | | 상태 (RUNNING, SUCCESS, ERROR) |
| START_DT | DATE | NOT NULL | 시작일시 |
| END_DT | DATE | | 종료일시 |
| ELAPSED_MS | INTEGER | | 소요시간(ms) |
| PROC_CNT | INTEGER | | 처리 건수 |
| ERROR_CD | VARCHAR2(20) | | 오류 코드 |
| ERROR_MSG | VARCHAR2(4000)| | 오류 메시지 |

---

### TS_INS_CONF (농장별 설정)

| 컬럼명 | 타입 | NULL | 설명 |
|--------|------|------|------|
| FARM_NO | INTEGER | PK, FK | 농장번호 (TA_FARM 참조) |
| WEEK_TW_GY | VARCHAR2(500) | | 교배 예정 산정 방식 (JSON) |
| WEEK_TW_BM | VARCHAR2(500) | | 분만 예정 산정 방식 (JSON) |
| WEEK_TW_IM | VARCHAR2(500) | | 임신감정(진단) 예정 산정 방식 (JSON) |
| WEEK_TW_EU | VARCHAR2(500) | | 이유 예정 산정 방식 (JSON) |
| WEEK_TW_VC | VARCHAR2(500) | | 모돈백신 예정 산정 방식 (JSON) |
| LOG_INS_DT | DATE | | 생성일 (UTC) |
| LOG_UPT_DT | DATE | | 수정일 (UTC) |

#### JSON 구조

```json
// 1. 농장 기본값 사용 (기본값)
{"method":"JOB"}

// 2. 모돈 작업설정 사용 (전체 작업)
{"method":"MODON"}

// 3. 모돈 작업설정 사용 (일부 작업 선택)
{"method":"MODON","tasks":["101","102","105"]}
```

| 필드 | 값 | 설명 |
|------|-----|------|
| method | `JOB` | 농장 기본값 사용 |
| method | `MODON` | 모돈 작업설정 사용 |
| tasks | `["SEQ1","SEQ2",...]` | 선택된 TB_SOW_JOB_CFG.SOW_JOB_CFG_SEQ 목록 |

> **참고**: tasks 배열이 없거나 비어있으면 해당 구분의 전체 작업 선택으로 간주

---

## 5. 데이터 보관 정책

| 유형 | 보관 기간 |
|------|----------|
| WEEK (주간) | 2년 |
| MON (월간) | 5년 |
| QT (분기) | 10년 |
| JOB_LOG | 6개월 |
| ACCESS_LOG | 1년 |

---

## 5. 이슈 사항

1. **오류 로깅 통합**: TS_INS_WEEK.ERROR_MSG 제거 → TS_INS_JOB_LOG에서 통합 관리
2. **실시간 진행현황**: TS_INS_MASTER.COMPLETE_CNT, ERROR_CNT는 농장 처리 완료 시 실시간 UPDATE
3. **Oracle 19c**: COMMENT ON SEQUENCE 미지원 → 인라인 주석 사용

---

## SQL 참조

- [02_TABLE.sql](../sql/ins/02_TABLE.sql) - INS 테이블 DDL
- [03_TABLE_ETC.sql](../sql/ins/03_TABLE_ETC.sql) - 공통/ETC 테이블 DDL
- [04_ALTER_SCHEDULE_GROUP.sql](../sql/ins/04_ALTER_SCHEDULE_GROUP.sql) - 스케줄 그룹 컬럼 추가 DDL
- [04_VIEW_INS_SERVICE_ACTIVE.sql](../sql/ins/04_VIEW_INS_SERVICE_ACTIVE.sql) - 유효 서비스 농장 View
- [07_TS_INS_CONF.sql](../sql/ins/07_TS_INS_CONF.sql) - 농장별 설정 테이블 DDL
- [10_ALTER_TS_INS_WEEK_ADD_SCHEDULE_GROUP.sql](../sql/ins/10_ALTER_TS_INS_WEEK_ADD_SCHEDULE_GROUP.sql) - TS_INS_WEEK 스케줄 그룹 컬럼 추가
