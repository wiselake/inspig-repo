# ETL 테이블 정의

> InsightPig ETL 주간/월간/분기 리포트용 테이블

---

## 테이블 구조도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TA_SYS_CONFIG (시스템 설정)                          │
│  - INS_SCHEDULE_YN: ETL 스케줄 실행 여부 (Y/N)                               │
│  - 전역 설정 (SEQ=1 단일 레코드)                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       TS_INS_SERVICE (서비스 신청)                           │
│  - 농장별 인사이트피그 서비스 신청 정보 (이력 관리)                             │
│  - PK: FARM_NO + INSPIG_REG_DT (복합키 - 농장당 N건 이력)                     │
│  - INSPIG_YN='Y' 농장만 리포트 생성 대상                                      │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ FARM_NO (1:N)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TS_INS_MASTER (리포트 마스터)                          │
│  - 주/월별 리포트 생성 배치 정보                                               │
│  - 대상 농장수, 완료 농장수, 실행 상태                                         │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ MASTER_SEQ (1:N)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TS_INS_WEEK (주간 리포트)                             │
│  - 농장별 리포트 요약 데이터                                                  │
│  - SHARE_TOKEN: 공유 URL 토큰 (64자 SHA256)                                  │
│  - 페이지 표시용 집계 수치                                                    │
└──────────────────────────────────┬──────────────────────────────────────────┘
                                   │ MASTER_SEQ + FARM_NO (1:N)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       TS_INS_WEEK_SUB (리포트 상세)                           │
│  - 각 팝업별 리스트 데이터                                                    │
│  - GUBUN: MODON/ALERT/GB/BM/EU/SG/DOPE/SHIP/SCHEDULE                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────┐     ┌───────────────────────────┐
│   TS_INS_JOB_LOG (로그)    │     │   TS_INS_ACCESS_LOG       │
│  - 프로시저 실행 로그       │     │  - 사용자 접속 로그         │
│  - MASTER_SEQ 연결         │     │  - 리포트 조회 이력         │
└───────────────────────────┘     └───────────────────────────┘

┌───────────────────────────┐     ┌───────────────────────────────────────────┐
│   TS_PSY_DELAY_HEATMAP    │     │           TM_WEATHER (일별)               │
│  - PSY/지연일 분포 히트맵   │     │  - 기상청 격자(NX, NY) 기준                 │
│  - MASTER_SEQ 연결         │     │  - 1주일 예보 + 당일 실측                   │
└───────────────────────────┘     │  - UK: NX + NY + WK_DATE                   │
                                  └──────────────────────┬────────────────────┘
                                                         │ NX + NY + WK_DATE (1:N)
┌───────────────────────────┐                            ▼
│        TA_FARM            │     ┌───────────────────────────────────────────┐
│  - WEATHER_NX, WEATHER_NY │────▶│       TM_WEATHER_HOURLY (시간별)           │
│  - 농장 좌표로 격자 변환    │     │  - 당일 시간별 상세 예보                     │
│  - N:1 관계 (다수 농장→1날씨)│     │  - UK: NX + NY + WK_DATE + WK_TIME        │
└───────────────────────────┘     └───────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       TS_PRODUCTIVITY (생산성 데이터)                         │
│  - 외부 API(10.4.35.10:11000) 수집 데이터                                    │
│  - PCODE: 031(교배)/032(분만)/033(이유)/034(번식종합)/035(모돈현황)           │
│  - PERIOD: W(주간)/M(월간)/Q(분기)                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 테이블 목록

| 테이블명 | 설명 | 용도 |
|----------|------|------|
| TA_SYS_CONFIG | 시스템 설정 | ETL 스케줄 실행 여부 설정 |
| TS_INS_SERVICE | 서비스 신청 | 농장별 서비스 신청 정보 |
| TS_INS_MASTER | 리포트 마스터 | 리포트 생성 배치 정보 |
| TS_INS_JOB_LOG | 스케줄러 로그 | 프로시저 실행 로그 |
| TS_INS_WEEK | 주간 리포트 | 농장별 주간 리포트 데이터 |
| TS_INS_WEEK_SUB | 리포트 상세 | 팝업/상세 데이터 |
| TS_INS_MGMT | 관리포인트 | 주요 포인트/추천 콘텐츠 |
| TS_INS_ACCESS_LOG | 접속 로그 | 사용자 접속 로그 |
| TS_INS_CONF | 농장별 설정 | 주간보고서 산정방식 (JSON) |
| TM_WEATHER | 날씨 정보 (일별) | 읍/면/동 기준 일별 날씨 |
| TM_WEATHER_HOURLY | 날씨 정보 (시간별) | 읍/면/동 기준 시간별 날씨 |
| TS_PSY_DELAY_HEATMAP | PSY 히트맵 | 농장 분포 히트맵 |
| TS_PRODUCTIVITY | 생산성 데이터 | 외부 API 수집 (PCODE별 통합) |

---

## 시간 저장 원칙

- **저장**: UTC (SYSDATE) - 글로벌 표준시간
- **계산/비교**: `SF_GET_LOCALE_VW_DATE_2022(LOCALE, SYSDATE)`
  - `KOR`: 한국 +09:00
  - `VNM`: 베트남 +07:00

---

## 1. TA_SYS_CONFIG (시스템 설정)

```sql
CREATE TABLE TA_SYS_CONFIG (
    SEQ             NUMBER DEFAULT 1,           -- 일련번호 (항상 1)
    MODON_HIST_YN   VARCHAR2(1) DEFAULT 'N',    -- 모돈이력제 연계여부 (Y/N)
    EKAPE_YN        VARCHAR2(1) DEFAULT 'N',    -- 축평원 등급판정 연계여부 (Y/N)
    INS_SCHEDULE_YN VARCHAR2(1) DEFAULT 'Y',    -- 인사이트피그플랜 실행여부 (Y/N), 테스트(T)
    TEST_TEL        VARCHAR2(18),               -- 테스트 SMS수신번호
    SISAE_YN        CHAR(1) DEFAULT 'Y',        -- 축평원 도축시세 연계 여부 (Y/N)
    WEATHER_YN      CHAR(1) DEFAULT 'Y',        -- 기상청 API 연계 여부 (Y/N), 테스트(T)
    LOG_INS_DT      DATE DEFAULT SYSDATE,       -- 생성일
    LOG_UPT_DT      DATE DEFAULT SYSDATE,       -- 수정일
    CONSTRAINT PK_TA_SYS_CONFIG PRIMARY KEY (SEQ)
);

-- 초기 데이터
INSERT INTO TA_SYS_CONFIG (SEQ, INS_SCHEDULE_YN) VALUES (1, 'Y');
```

### INS_SCHEDULE_YN 값

| 값 | 설명 | ETL 배치 | 웹 API | 알림톡 발송 번호 |
|----|------|---------|--------|-----------------|
| Y | 운영 모드 | 정상 실행 | 정상 | TA_MEMBER.HP_NUM |
| T | 테스트 모드 | 정상 실행 | 정상 | TA_SYS_CONFIG.TEST_TEL |
| N | 비활성화 | 스킵 | 비활성화 | - |

**참고:** `T` 모드에서 ETL과 웹 API는 `Y`와 동일하게 동작하며, 알림톡만 `TEST_TEL`로 발송됩니다.

---

## 2. TS_INS_SERVICE (서비스 신청)

농장별 인사이트피그 서비스 구독 이력 관리 테이블

```sql
CREATE TABLE TS_INS_SERVICE (
    FARM_NO                  INTEGER NOT NULL,           -- 농장번호 (PK 일부, FK)
    INSPIG_REG_DT            VARCHAR2(8) NOT NULL,       -- 등록일 (PK 일부, YYYYMMDD)
    INSPIG_YN                VARCHAR2(1) DEFAULT 'N',    -- 서비스 신청여부
    INSPIG_FROM_DT           VARCHAR2(8),                -- 시작일 (YYYYMMDD)
    INSPIG_TO_DT             VARCHAR2(8),                -- 종료일 (YYYYMMDD)
    INSPIG_STOP_DT           VARCHAR2(8),                -- 중단일 (YYYYMMDD)
    WEB_PAY_YN               VARCHAR2(1) DEFAULT 'N',    -- 웹결재 여부
    REG_TYPE                 VARCHAR2(10) DEFAULT 'AUTO', -- AUTO/MANUAL
    USE_YN                   VARCHAR2(1) DEFAULT 'Y',
    BIGO                     VARCHAR2(500),              -- 비고
    SCHEDULE_GROUP_WEEK      VARCHAR2(10),               -- 주간 알림톡 발송 그룹 (AM7/PM2)
    SCHEDULE_GROUP_MONTH     VARCHAR2(10),               -- 월간 알림톡 발송 그룹 (AM7/PM2)
    SCHEDULE_GROUP_QUARTER   VARCHAR2(10),               -- 분기 알림톡 발송 그룹 (AM7/PM2)
    LOG_INS_DT               DATE DEFAULT SYSDATE,
    LOG_UPT_DT               DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_SERVICE PRIMARY KEY (FARM_NO, INSPIG_REG_DT)
);

-- 인덱스
CREATE INDEX IDX_TS_INS_SERVICE_01 ON TS_INS_SERVICE(FARM_NO, INSPIG_REG_DT DESC);
CREATE INDEX IDX_TS_INS_SERVICE_02 ON TS_INS_SERVICE(FARM_NO, INSPIG_FROM_DT, INSPIG_TO_DT);
```

### PK 구조

- **FARM_NO + INSPIG_REG_DT**: 복합키 (농장당 N건 이력 관리)
- 동일 농장에 여러 구독 기간 저장 가능
- 현재 유효한 구독은 `INSPIG_YN='Y'`, `USE_YN='Y'`, 기간 조건 충족 건 중 최신 `INSPIG_REG_DT`

### REG_TYPE 값

| 값 | 설명 |
|----|------|
| AUTO | 정기 스케줄 대상 (기본값) |
| MANUAL | 수동 등록 (테스트/개별 실행) |

### 스케줄 그룹별 발송 시간 (KST)

| 그룹 | ETL 실행 | 알림톡 발송 |
|------|---------|------------|
| AM7 | 월요일 02:00 | 월요일 07:00 |
| PM2 | 월요일 12:00 | 월요일 14:00 |

### 유효 서비스 조회 조건

```sql
-- 현재 유효한 서비스 조회 (ETL에서 사용)
SELECT S1.FARM_NO, S1.INSPIG_REG_DT, ...
FROM TS_INS_SERVICE S1
WHERE S1.INSPIG_YN = 'Y'
  AND S1.USE_YN = 'Y'
  AND S1.INSPIG_FROM_DT IS NOT NULL
  AND S1.INSPIG_TO_DT IS NOT NULL
  AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= S1.INSPIG_FROM_DT
  AND TO_CHAR(SYSDATE, 'YYYYMMDD') <= LEAST(
      S1.INSPIG_TO_DT,
      NVL(S1.INSPIG_STOP_DT, '99991231')
  )
  -- 같은 농장 중 유효한 최신 건만 조회
  AND S1.INSPIG_REG_DT = (
      SELECT MAX(S2.INSPIG_REG_DT)
      FROM TS_INS_SERVICE S2
      WHERE S2.FARM_NO = S1.FARM_NO
        AND S2.INSPIG_YN = 'Y'
        AND S2.USE_YN = 'Y'
        AND S2.INSPIG_FROM_DT IS NOT NULL
        AND S2.INSPIG_TO_DT IS NOT NULL
        AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= S2.INSPIG_FROM_DT
        AND TO_CHAR(SYSDATE, 'YYYYMMDD') <= LEAST(
            S2.INSPIG_TO_DT,
            NVL(S2.INSPIG_STOP_DT, '99991231')
        )
  )
```

---

## 3. TS_INS_MASTER (리포트 마스터)

```sql
CREATE TABLE TS_INS_MASTER (
    SEQ             NUMBER NOT NULL,            -- 일련번호 (PK)
    DAY_GB          VARCHAR2(10) NOT NULL,      -- WEEK/MON/QT
    INS_DT          CHAR(8) NOT NULL,           -- 생성기준일 (YYYYMMDD)

    -- 기간 정보
    REPORT_YEAR     NUMBER(4) NOT NULL,         -- 년도
    REPORT_WEEK_NO  NUMBER(2) NOT NULL,         -- 주차(1~53)/월(1~12)
    DT_FROM         VARCHAR2(8) NOT NULL,       -- 시작일 (YYYYMMDD)
    DT_TO           VARCHAR2(8) NOT NULL,       -- 종료일 (YYYYMMDD)

    -- 실행 현황
    TARGET_CNT      INTEGER DEFAULT 0,          -- 대상 농장수
    COMPLETE_CNT    INTEGER DEFAULT 0,          -- 완료 농장수
    ERROR_CNT       INTEGER DEFAULT 0,          -- 오류 농장수

    -- 상태
    STATUS_CD       VARCHAR2(10) DEFAULT 'READY', -- READY/RUNNING/COMPLETE/ERROR
    START_DT        DATE,                       -- 시작일시
    END_DT          DATE,                       -- 종료일시
    ELAPSED_SEC     INTEGER DEFAULT 0,          -- 소요시간(초)

    LOG_INS_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_MASTER PRIMARY KEY (SEQ)
);

-- 인덱스
CREATE UNIQUE INDEX UK_TS_INS_MASTER_01 ON TS_INS_MASTER(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO);
CREATE INDEX IDX_TS_INS_MASTER_01 ON TS_INS_MASTER(DAY_GB, INS_DT);
CREATE INDEX IDX_TS_INS_MASTER_02 ON TS_INS_MASTER(STATUS_CD);
```

### DAY_GB 값

| 값 | 설명 |
|----|------|
| WEEK | 주간 리포트 |
| MON | 월간 리포트 |
| QT | 분기 리포트 |

---

## 4. TS_INS_JOB_LOG (스케줄러 로그)

```sql
CREATE TABLE TS_INS_JOB_LOG (
    SEQ             NUMBER NOT NULL,            -- 일련번호 (PK)
    MASTER_SEQ      NUMBER,                     -- FK (NULL 허용)
    JOB_NM          VARCHAR2(50) NOT NULL,      -- JOB 이름
    PROC_NM         VARCHAR2(50) NOT NULL,      -- 프로시저명
    FARM_NO         INTEGER,                    -- 농장번호 (NULL=전체)

    -- 리포트 정보
    DAY_GB          VARCHAR2(10),               -- WEEK/MON/QT
    REPORT_YEAR     NUMBER(4),
    REPORT_WEEK_NO  NUMBER(2),

    -- 실행 상태
    STATUS_CD       VARCHAR2(10) DEFAULT 'RUNNING', -- RUNNING/SUCCESS/ERROR
    START_DT        DATE NOT NULL,
    END_DT          DATE,
    ELAPSED_MS      INTEGER DEFAULT 0,          -- 소요시간(ms)

    -- 처리 결과
    PROC_CNT        INTEGER DEFAULT 0,          -- 처리 건수
    ERROR_CD        VARCHAR2(20),
    ERROR_MSG       VARCHAR2(4000),
    ERROR_STACK     CLOB,                       -- 스택 트레이스

    LOG_INS_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_JOB_LOG PRIMARY KEY (SEQ)
);

-- 인덱스
CREATE INDEX IDX_TS_INS_JOB_LOG_01 ON TS_INS_JOB_LOG(MASTER_SEQ);
CREATE INDEX IDX_TS_INS_JOB_LOG_02 ON TS_INS_JOB_LOG(JOB_NM, START_DT);
CREATE INDEX IDX_TS_INS_JOB_LOG_03 ON TS_INS_JOB_LOG(STATUS_CD, START_DT);
CREATE INDEX IDX_TS_INS_JOB_LOG_04 ON TS_INS_JOB_LOG(MASTER_SEQ, FARM_NO, STATUS_CD);
CREATE INDEX IDX_TS_INS_JOB_LOG_05 ON TS_INS_JOB_LOG(DAY_GB, REPORT_YEAR, REPORT_WEEK_NO);
```

### 보관 정책

- 6개월 보관, 이전 로그 자동 삭제

---

## 5. TS_INS_WEEK (주간 리포트)

```sql
CREATE TABLE TS_INS_WEEK (
    MASTER_SEQ      NUMBER NOT NULL,            -- FK → TS_INS_MASTER
    FARM_NO         INTEGER NOT NULL,           -- FK → TS_INS_SERVICE

    -- 기간 정보
    REPORT_YEAR     NUMBER(4),
    REPORT_WEEK_NO  NUMBER(2),
    DT_FROM         VARCHAR2(8),
    DT_TO           VARCHAR2(8),

    -- 헤더 정보
    FARM_NM         VARCHAR2(100),              -- 농장명
    OWNER_NM        VARCHAR2(50),               -- 대표자명
    SIGUNGU_CD      VARCHAR2(10),               -- 시군구코드 (날씨용)

    -- 모돈 현황
    MODON_REG_CNT   INTEGER DEFAULT 0,          -- 현재모돈수
    MODON_REG_CHG   INTEGER DEFAULT 0,          -- 증감
    MODON_SANGSI_CNT INTEGER DEFAULT 0,         -- 상시모돈수
    MODON_SANGSI_CHG INTEGER DEFAULT 0,         -- 증감

    -- 관리대상 모돈 (alertMd)
    ALERT_TOTAL     INTEGER DEFAULT 0,
    ALERT_HUBO      INTEGER DEFAULT 0,          -- 미교배 후보돈
    ALERT_EU_MI     INTEGER DEFAULT 0,          -- 이유후 미교배
    ALERT_SG_MI     INTEGER DEFAULT 0,          -- 사고후 미교배
    ALERT_BM_DELAY  INTEGER DEFAULT 0,          -- 분만지연
    ALERT_EU_DELAY  INTEGER DEFAULT 0,          -- 이유지연

    -- 지난주 교배 (lastWeek.mating)
    LAST_GB_CNT     INTEGER DEFAULT 0,          -- 교배 복수
    LAST_GB_SUM     INTEGER DEFAULT 0,          -- 누계

    -- 지난주 분만 (lastWeek.farrowing)
    LAST_BM_CNT     INTEGER DEFAULT 0,          -- 분만 복수
    LAST_BM_TOTAL   INTEGER DEFAULT 0,          -- 총산자수
    LAST_BM_LIVE    INTEGER DEFAULT 0,          -- 실산자수
    LAST_BM_DEAD    INTEGER DEFAULT 0,          -- 사산
    LAST_BM_MUMMY   INTEGER DEFAULT 0,          -- 미라
    LAST_BM_SUM_CNT INTEGER DEFAULT 0,          -- 누계 복수
    LAST_BM_SUM_TOTAL INTEGER DEFAULT 0,        -- 총산 누계
    LAST_BM_SUM_LIVE INTEGER DEFAULT 0,         -- 실산 누계
    LAST_BM_AVG_TOTAL NUMBER(5,1) DEFAULT 0,    -- 총산 평균
    LAST_BM_AVG_LIVE NUMBER(5,1) DEFAULT 0,     -- 실산 평균
    LAST_BM_SUM_AVG_TOTAL NUMBER(5,1) DEFAULT 0,
    LAST_BM_SUM_AVG_LIVE NUMBER(5,1) DEFAULT 0,

    -- 지난주 이유 (lastWeek.weaning)
    LAST_EU_CNT     INTEGER DEFAULT 0,          -- 이유 복수
    LAST_EU_JD_CNT  INTEGER DEFAULT 0,          -- 이유자돈수
    LAST_EU_AVG_JD  NUMBER(5,1) DEFAULT 0,      -- 평균 이유두수
    LAST_EU_AVG_KG  NUMBER(5,1) DEFAULT 0,      -- 평균체중
    LAST_EU_SUM_CNT INTEGER DEFAULT 0,
    LAST_EU_SUM_JD  INTEGER DEFAULT 0,
    LAST_EU_SUM_AVG_JD NUMBER(5,1) DEFAULT 0,

    -- 지난주 사고 (lastWeek.accident)
    LAST_SG_CNT     INTEGER DEFAULT 0,
    LAST_SG_AVG_GYUNGIL NUMBER(5,1) DEFAULT 0,
    LAST_SG_SUM     INTEGER DEFAULT 0,
    LAST_SG_SUM_AVG_GYUNGIL NUMBER(5,1) DEFAULT 0,

    -- 지난주 도폐 (lastWeek.culling)
    LAST_CL_CNT     INTEGER DEFAULT 0,
    LAST_CL_SUM     INTEGER DEFAULT 0,

    -- 지난주 출하 (lastWeek.shipment)
    LAST_SH_CNT     INTEGER DEFAULT 0,
    LAST_SH_AVG_KG  NUMBER(5,1) DEFAULT 0,
    LAST_SH_SUM     INTEGER DEFAULT 0,
    LAST_SH_AVG_SUM NUMBER(5,1) DEFAULT 0,

    -- 금주 예정 (thisWeek)
    THIS_GB_SUM     INTEGER DEFAULT 0,          -- 교배 예정
    THIS_IMSIN_SUM  INTEGER DEFAULT 0,          -- 임신확인 예정
    THIS_BM_SUM     INTEGER DEFAULT 0,          -- 분만 예정
    THIS_EU_SUM     INTEGER DEFAULT 0,          -- 이유 예정
    THIS_VACCINE_SUM INTEGER DEFAULT 0,         -- 백신 예정
    THIS_SHIP_SUM   INTEGER DEFAULT 0,          -- 출하 예정

    -- KPI
    KPI_PSY         NUMBER(5,1) DEFAULT 0,
    KPI_DELAY_DAY   INTEGER DEFAULT 0,          -- 입력지연일
    PSY_X           INTEGER DEFAULT 0,
    PSY_Y           INTEGER DEFAULT 0,
    PSY_ZONE        VARCHAR2(10),               -- 1A~4D

    -- 상태
    STATUS_CD       VARCHAR2(10) DEFAULT 'READY',

    -- 공유 토큰
    SHARE_TOKEN     VARCHAR2(64),               -- SHA256 (64자)
    TOKEN_EXPIRE_DT VARCHAR2(8),                -- 만료일

    -- 알림톡 발송 그룹 스냅샷
    SCHEDULE_GROUP  VARCHAR2(10),               -- ETL 시점 스냅샷 (AM7/PM2)

    LOG_INS_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_WEEK PRIMARY KEY (MASTER_SEQ, FARM_NO)
);

-- 인덱스
CREATE INDEX IDX_TS_INS_WEEK_01 ON TS_INS_WEEK(FARM_NO, MASTER_SEQ);
CREATE INDEX IDX_TS_INS_WEEK_02 ON TS_INS_WEEK(FARM_NO, REPORT_YEAR, REPORT_WEEK_NO);
CREATE UNIQUE INDEX UK_TS_INS_WEEK_TOKEN ON TS_INS_WEEK(SHARE_TOKEN);
```

### SCHEDULE_GROUP 컬럼 설명

- ETL 실행 시점에 `TS_INS_SERVICE.SCHEDULE_GROUP_WEEK` 값을 스냅샷으로 저장
- 알림톡 발송 시 이 값 기준으로 AM7/PM2 그룹 필터링
- ETL 시점과 발송 시점 사이에 설정 변경되어도 정확한 발송 보장

---

## 6. TS_INS_WEEK_SUB (리포트 상세)

팝업/섹션별 상세 데이터 저장

```sql
CREATE TABLE TS_INS_WEEK_SUB (
    MASTER_SEQ      NUMBER NOT NULL,
    FARM_NO         INTEGER NOT NULL,
    GUBUN           VARCHAR2(20) NOT NULL,      -- 데이터 구분
    SUB_GUBUN       VARCHAR2(20) DEFAULT '-',   -- 세부 구분
    SORT_NO         INTEGER DEFAULT 0,          -- 정렬순서

    -- 코드
    CODE_1          VARCHAR2(30),               -- 1차 구분코드
    CODE_2          VARCHAR2(30),               -- 2차 구분코드

    -- 숫자형 (CNT_1 ~ CNT_15)
    CNT_1 ~ CNT_15  NUMBER(10,2) DEFAULT 0,

    -- 수치형 (VAL_1 ~ VAL_15)
    VAL_1 ~ VAL_15  NUMBER(10,2) DEFAULT 0,

    -- 문자형 (STR_1 ~ STR_15)
    STR_1 ~ STR_15  VARCHAR2(1000),

    LOG_INS_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_WEEK_SUB PRIMARY KEY (MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO)
);
```

### GUBUN 값

| 값 | 설명 | 내용 |
|----|------|------|
| MODON | 모돈현황 팝업 | 산차별 현황 |
| ALERT | 관리대상 팝업 | 미교배/지연 모돈 목록 |
| GB | 교배 팝업 | 교배 통계/목록 |
| BM | 분만 팝업 | 분만 통계/목록 |
| EU | 이유 팝업 | 이유 통계/목록 |
| SG | 임신사고 팝업 | 사고 통계/목록 |
| DOPE | 도폐 팝업 | 도폐 통계/목록 |
| SHIP | 출하 팝업 | 출하 통계/목록 |
| SCHEDULE | 예정 캘린더 | 일별 예정 작업 |

### SUB_GUBUN 값

| 값 | 설명 |
|----|------|
| STAT | 요약 통계 |
| LIST | 목록 데이터 |
| CHART | 차트 데이터 |
| ROW | 행 데이터 |

---

## 7. TS_INS_CONF (농장별 설정)

```sql
CREATE TABLE TS_INS_CONF (
    FARM_NO         INTEGER NOT NULL,           -- 농장번호 (PK, FK → TA_FARM)
    WEEK_TW_GY      VARCHAR2(500),              -- 교배 예정 산정 방식 (JSON)
    WEEK_TW_BM      VARCHAR2(500),              -- 분만 예정 산정 방식 (JSON)
    WEEK_TW_IM      VARCHAR2(500),              -- 임신감정(진단) 예정 산정 방식 (JSON)
    WEEK_TW_EU      VARCHAR2(500),              -- 이유 예정 산정 방식 (JSON)
    WEEK_TW_VC      VARCHAR2(500),              -- 모돈백신 예정 산정 방식 (JSON)
    LOG_INS_DT      DATE DEFAULT SYSDATE,
    LOG_UPT_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_INS_CONF PRIMARY KEY (FARM_NO)
);
```

### JSON 구조

```json
// 1. 농장 기본값 사용 (기본값)
{"method":"JOB"}

// 2. 모돈 작업설정 사용 (전체 작업)
{"method":"MODON"}

// 3. 모돈 작업설정 사용 (일부 작업 선택)
{"method":"MODON","tasks":["101","102","105"]}
```

| 필드 | 값 | 설명 |
|------|-----|------|
| method | `JOB` | 농장 기본값 사용 |
| method | `MODON` | 모돈 작업설정 사용 |
| tasks | `["SEQ1","SEQ2",...]` | 선택된 TB_SOW_JOB_CFG.SOW_JOB_CFG_SEQ 목록 |

> **참고**: tasks 배열이 없거나 비어있으면 해당 구분의 전체 작업 선택으로 간주

---

## 8. 부가 테이블

### TM_WEATHER / TM_WEATHER_HOURLY (날씨)

기상청 격자(NX, NY) 기준 날씨 데이터

| 테이블 | UK | 설명 |
|--------|-----|------|
| TM_WEATHER | NX + NY + WK_DATE | 일별 날씨 |
| TM_WEATHER_HOURLY | NX + NY + WK_DATE + WK_TIME | 시간별 날씨 |

- **관계**: TA_FARM N:1 TM_WEATHER (다수 농장 → 1개 날씨)
- **격자 변환**: TA_FARM.MAP_X/Y → WEATHER_NX/NY (5km 단위)

> **상세 문서**: [07_WEATHER_COLLECT.md](../../etl/07_WEATHER_COLLECT.md)

### TS_PSY_DELAY_HEATMAP (히트맵)

```sql
CREATE TABLE TS_PSY_DELAY_HEATMAP (
    MASTER_SEQ      NUMBER NOT NULL,
    X_POS           INTEGER NOT NULL,           -- 0~3: 입력지연일 구간
    Y_POS           INTEGER NOT NULL,           -- 0~3: PSY 구간
    ZONE_CD         VARCHAR2(10),               -- 1A~4D
    FARM_CNT        INTEGER DEFAULT 0,
    LOG_INS_DT      DATE DEFAULT SYSDATE,
    CONSTRAINT PK_TS_PSY_DELAY_HEATMAP PRIMARY KEY (MASTER_SEQ, X_POS, Y_POS)
);
```

---

## 9. TS_PRODUCTIVITY (생산성 데이터)

외부 API(10.4.35.10:11000)에서 수집한 생산성 지표 저장

| 항목 | 설명 |
|------|------|
| UK | FARM_NO + PCODE + STAT_YEAR + PERIOD + PERIOD_NO |
| PCODE | 031(교배), 032(분만), 033(이유), 034(번식종합), 035(모돈현황) |
| PERIOD | W(주간), M(월간), Q(분기) |

> **상세 문서**: [06_PRODUCTIVITY_COLLECT.md](../../etl/06_PRODUCTIVITY_COLLECT.md)

---

## 데이터 보관 정책

| 유형 | 보관 기간 |
|------|----------|
| WEEK (주간) | 2년 |
| MON (월간) | 5년 |
| QT (분기) | 10년 |
| JOB_LOG | 6개월 |
| ACCESS_LOG | 1년 |

---

## 이슈 사항

1. **오류 로깅 통합**: TS_INS_WEEK.ERROR_MSG 제거 → TS_INS_JOB_LOG에서 통합 관리
2. **실시간 진행현황**: TS_INS_MASTER.COMPLETE_CNT, ERROR_CNT는 농장 처리 완료 시 실시간 UPDATE
3. **Oracle 19c**: COMMENT ON SEQUENCE 미지원 → 인라인 주석 사용

---

## 성능 최적화 인덱스 (운영 DB)

```sql
-- TM_LPD_DATA (약 1,000만 건) - 출하 조회용
CREATE INDEX IDX_TM_LPD_DATA_INS_01 ON TM_LPD_DATA (FARM_NO, DOCHUK_DT);

-- TB_EU (약 1,100만 건) - 이유 조회용
CREATE INDEX IDX_TB_EU_INS_01 ON TB_EU (FARM_NO, WK_DT);
```

---

## SQL 참조

- [02_TABLE.sql](../sql/ins/02_TABLE.sql) - INS 테이블 DDL
- [03_TABLE_ETC.sql](../sql/ins/03_TABLE_ETC.sql) - 공통/ETC 테이블 DDL
- [04_ALTER_SCHEDULE_GROUP.sql](../sql/ins/04_ALTER_SCHEDULE_GROUP.sql) - 스케줄 그룹 컬럼 추가 DDL
- [07_TS_INS_CONF.sql](../sql/ins/07_TS_INS_CONF.sql) - 농장별 설정 테이블 DDL
