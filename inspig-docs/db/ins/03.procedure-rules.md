# INS 프로시저 생성 규칙

> TS_INS_WEEK_SUB 테이블 데이터 저장 규칙 및 컬럼 매핑 가이드

---

## 1. 테이블 구조 개요

### TS_INS_WEEK_SUB 키 구조

```
PK: (MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO)
```

| 컬럼 | 타입 | 설명 | 예시 |
|------|------|------|------|
| GUBUN | VARCHAR2(20) | 팝업/섹션 식별 | `GB`, `BM`, `SCHEDULE` |
| SUB_GUBUN | VARCHAR2(20) | 세부 데이터 유형 | `STAT`, `LIST`, `CHART` |
| SORT_NO | INTEGER | 정렬순서/행번호 | `0`, `1`, `2`... |

### SUB_GUBUN 표준 코드

| 코드 | 설명 | 용도 |
|------|------|------|
| `-` | 기본값 (단일 데이터) | 1건만 있는 요약 데이터 |
| `STAT` | 통계 요약 | 합계, 평균, 비율 등 요약값 |
| `LIST` | 목록 데이터 | 여러 행의 리스트 |
| `CHART` | 차트 데이터 | 그래프용 데이터 |
| `ROW` | 행 데이터 | 크로스탭/피벗 테이블 |

---

## 2. 데이터 저장 원칙

### 원칙 1: 최소 행 생성

```
✅ 가급적 1개 ROW로 저장
✅ CNT_1~15, VAL_1~15, STR_1~15 컬럼 최대 활용
❌ 불필요하게 여러 행 생성 금지
```

**좋은 예**: 7일치 캘린더 데이터를 1행에 저장
```sql
-- 1행으로 7일 데이터 저장
INSERT INTO TS_INS_WEEK_SUB (GUBUN, SUB_GUBUN, SORT_NO, CNT_1, CNT_2, ..., CNT_7)
VALUES ('SCHEDULE', 'GB', 0, 3, 2, 5, 0, 1, 4, 2);  -- 월~일 교배예정
```

**나쁜 예**: 각 날짜를 별도 행으로 저장
```sql
-- 7행 생성 (비효율)
INSERT INTO TS_INS_WEEK_SUB VALUES ('SCHEDULE_GB_MON', ..., 3);
INSERT INTO TS_INS_WEEK_SUB VALUES ('SCHEDULE_GB_TUE', ..., 2);
...
```

### 원칙 2: GUBUN + SUB_GUBUN 조합으로 구분

```
GUBUN: 팝업/기능 단위 (교배=GB, 분만=BM, 출하=SHIP 등)
SUB_GUBUN: 데이터 유형 (요약=STAT, 목록=LIST, 차트=CHART)
```

**구조화된 예시**:
| GUBUN | SUB_GUBUN | 설명 |
|-------|-----------|------|
| `GB` | `-` | 교배 요약 (1행) |
| `GB` | `CHART` | 교배 재귀일 차트 |
| `SHIP` | `STAT` | 출하 요약 통계 |
| `SHIP` | `ROW` | 출하 크로스탭 행 |
| `SHIP` | `CHART` | 출하 분석 차트 |

### 원칙 3: 코드는 코드로 저장, 변환은 API에서

```sql
-- ✅ 코드값 저장 (프로시저)
INSERT INTO TS_INS_WEEK_SUB (STR_2, STR_3)
VALUES ('020003', '010002');  -- 기준작업코드, 대상돈군코드

-- API에서 변환
const baseTask = comService.getCodeSysName('02', str2);    // '교배'
const targetGroup = comService.getCodeSysName('01', str3); // '임신돈'
```

```sql
-- ❌ 코드명 저장 (금지)
INSERT INTO TS_INS_WEEK_SUB (STR_2, STR_3)
VALUES ('교배', '임신돈');  -- 다국어 지원 불가
```

---

## 3. GUBUN 코드 체계

### 지난주 실적 팝업

| GUBUN | SUB_GUBUN | 설명 | SORT_NO |
|-------|-----------|------|---------|
| `MODON` | `-` | 모돈현황 산차별×상태별 | 0~9 (산차별) |
| `GB` | `-` | 교배 요약 | 0 |
| `GB` | `CHART` | 재귀일별 차트 | 0~N |
| `BM` | `-` | 분만 요약 | 0 |
| `EU` | `-` | 이유 요약 | 0 |
| `SG` | `STAT` | 임신사고 원인별 | 1=지난주, 2=1개월 |
| `SG` | `CHART` | 임신일별 차트 | 0 |
| `DOPE` | `STAT` | 도태폐사 유형별 | 0 |
| `DOPE` | `LIST` | 원인별 목록 | 1~N |
| `DOPE` | `CHART` | 상태별 차트 | 0 |
| `SHIP` | `STAT` | 출하 요약 | 0 |
| `SHIP` | `ROW` | 크로스탭 행 | 1~13 |
| `SHIP` | `CHART` | 분석 차트 | 1~7 |
| `SHIP` | `SCATTER` | 산점도 | 1~N |

### 금주 예정 팝업

| GUBUN | SUB_GUBUN | 설명 | SORT_NO |
|-------|-----------|------|---------|
| `SCHEDULE` | `-` | 예정 요약 | 0 |
| `SCHEDULE` | `CAL` | 캘린더 행 | 1~6 (작업유형) |
| `SCHEDULE` | `GB` | 교배예정 목록 | 1~N |
| `SCHEDULE` | `BM` | 분만예정 목록 | 1~N |
| `SCHEDULE` | `EU` | 이유예정 목록 | 1~N |
| `SCHEDULE` | `VACCINE` | 백신예정 목록 | 1~N |

### 알림/관리대상

| GUBUN | SUB_GUBUN | 설명 | SORT_NO |
|-------|-----------|------|---------|
| `ALERT` | `-` | 관리대상 기간별 | 1~N |
| `ALERT` | `LIST` | 관리대상 모돈목록 | 1~N |

---

## 4. 컬럼 매핑 가이드

### 숫자 컬럼 (CNT_1~15, VAL_1~15)

| 용도 | 컬럼 | 설명 |
|------|------|------|
| 두수/복수 | CNT_1~15 | 정수형 카운트 |
| 합계 | CNT_1~15 | 집계값 |
| 평균 | VAL_1~15 | 소수점 필요 시 |
| 비율(%) | VAL_1~15 | 백분율 |
| 일별 데이터 | CNT_1~7 | 월~일 순서 |

### 문자 컬럼 (STR_1~15)

| 용도 | 컬럼 | 설명 |
|------|------|------|
| 코드값 | STR_1~15 | 시스템 코드 저장 |
| 날짜(DD) | STR_1~7 | 일자 (01~31) |
| 명칭 | STR_1~15 | 작업명, 백신명 등 |

### 코드 컬럼 (CODE_1, CODE_2)

| 용도 | 컬럼 | 설명 |
|------|------|------|
| 행 식별 | CODE_1 | 산차, 기간, 유형 등 |
| 그룹 | CODE_2 | 상세 분류 |

---

## 5. 프로시저 네이밍 규칙

```
SP_INS_WEEK_{섹션}[_{상세}]
```

| 프로시저명 | 설명 |
|-----------|------|
| `SP_INS_WEEK_MAIN` | 메인 실행 (기본 통계) |
| `SP_INS_WEEK_MODON_POPUP` | 모돈현황 팝업 |
| `SP_INS_WEEK_GB_POPUP` | 교배실적 팝업 |
| `SP_INS_WEEK_BM_POPUP` | 분만실적 팝업 |
| `SP_INS_WEEK_EU_POPUP` | 이유실적 팝업 |
| `SP_INS_WEEK_SG_POPUP` | 임신사고 팝업 |
| `SP_INS_WEEK_DOPE_POPUP` | 도태폐사 팝업 |
| `SP_INS_WEEK_SHIP_POPUP` | 출하실적 팝업 |
| `SP_INS_WEEK_SCHEDULE_POPUP` | 금주예정 팝업 |
| `SP_INS_WEEK_ALERT_POPUP` | 관리대상 팝업 |

---

## 6. INSERT 템플릿

### 단일 요약 (1행)

```sql
INSERT INTO TS_INS_WEEK_SUB (
    MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO,
    CNT_1, CNT_2, CNT_3, VAL_1, VAL_2
)
VALUES (
    P_MASTER_SEQ, P_FARM_NO, 'GB', '-', 0,
    V_TOTAL_CNT, V_FIRST_GB, V_NORMAL_GB, V_AVG_RETURN, V_AVG_FIRST
);
```

### 목록 데이터 (N행)

```sql
INSERT INTO TS_INS_WEEK_SUB (
    MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO,
    STR_1, STR_2, STR_3, STR_4, CNT_1
)
SELECT P_MASTER_SEQ, P_FARM_NO, 'SCHEDULE', 'GB', ROWNUM,
       WK_NM,           -- 작업명
       STD_CD,          -- 기준작업코드 (API에서 변환)
       MODON_STATUS_CD, -- 대상돈군코드 (API에서 변환)
       PASS_DAY || '일',
       CNT
FROM (
    SELECT ... GROUP BY WK_NM ORDER BY WK_NM
);
```

### 캘린더 데이터 (고정 행)

```sql
-- 6개 작업유형을 6행으로 저장 (CODE_1로 구분)
INSERT INTO TS_INS_WEEK_SUB (
    MASTER_SEQ, FARM_NO, GUBUN, SUB_GUBUN, SORT_NO,
    CODE_1, STR_1, STR_2, STR_3, STR_4, STR_5, STR_6, STR_7,
    CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6, CNT_7
)
SELECT P_MASTER_SEQ, P_FARM_NO, 'SCHEDULE', 'CAL', ROW_NUM,
       TYPE_CD,        -- GB, BM, EU 등
       D1, D2, D3, D4, D5, D6, D7,     -- 날짜 (DD)
       C1, C2, C3, C4, C5, C6, C7      -- 두수
FROM (...);
```

---

## 7. API 조회 패턴

### weekly.service.ts 예시

```typescript
// GUBUN + SUB_GUBUN으로 데이터 추출
const scheduleGbList = subs
  .filter(s => s.gubun === 'SCHEDULE' && s.subGubun === 'GB')
  .sort((a, b) => a.sortNo - b.sortNo)
  .map(s => ({
    taskNm: s.str1,
    baseTask: this.comService.getCodeSysName('02', s.str2) || s.str2,
    targetGroup: this.comService.getCodeSysName('01', s.str3) || s.str3,
    elapsedDays: s.str4,
    count: s.cnt1,
  }));
```

---

## 8. 기존 GUBUN 마이그레이션

기존 `SCHEDULE_GB`, `SCHEDULE_BM` 형태를 새 구조로 변환:

| 기존 GUBUN | 신규 GUBUN | SUB_GUBUN |
|-----------|-----------|-----------|
| SCHEDULE_GB | SCHEDULE | GB |
| SCHEDULE_BM | SCHEDULE | BM |
| SCHEDULE_EU | SCHEDULE | EU |
| SCHEDULE_VACCINE | SCHEDULE | VACCINE |
| SCHEDULE_CAL | SCHEDULE | CAL |
| GB | GB | - |
| GB_CHART | GB | CHART |
| DOPE | DOPE | STAT |
| DOPE_R_1 | DOPE | LIST |
| DOPE_CHART | DOPE | CHART |
| SHIP_STAT | SHIP | STAT |
| SHIP_ROW | SHIP | ROW |
| SHIP_CHART | SHIP | CHART |
| SHIP_SCATTER | SHIP | SCATTER |

---

## 참조

- [02_TABLE.sql](../sql/ins/02_TABLE.sql) - 테이블 DDL
- [00_SQL_GUIDE.md](../sql/00_SQL_GUIDE.md) - SQL 가이드
