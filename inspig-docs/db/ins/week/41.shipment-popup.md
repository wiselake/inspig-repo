# 출하 팝업 데이터 (SP_INS_WEEK_SHIP_POPUP)

> 지난주 출하현황 및 도체분석 팝업 데이터 추출

---

## 1. 개요

출하 팝업은 3탭 구조로 구성:
- **탭1 (출하현황)**: 요약 메트릭스 + 등급 차트 + 일별/항목별 크로스탭 테이블
- **탭2 (출하분석)**: 출하두수, 체중, 등지방 복합 차트
- **탭3 (도체분포)**: 도체중 × 등지방 산점도

---

## 2. 데이터 구조

### TM_LPD_DATA 테이블 참조 (docs/db/ref/01.table.md)

| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| LPD_SEQ | NUMBER | 일련번호 (PK) |
| FARM_NO | NUMBER | 농장번호 (FK) |
| DOCHUK_DT | VARCHAR2(10) | 도축일 (YYYY-MM-DD 형식) |
| NET_KG | NUMBER(8,2) | 지육체중(도체중) kg |
| BACK_DEPTH | NUMBER(8,2) | 등지방두께 mm |
| MEAT_QUALITY | VARCHAR2(6) | 육질(최종등급) '1+', '1', '2', '등외' |
| SEX_GUBUN | VARCHAR2(10) | 성별구분 'F'=암, 'M'=수, 기타=거세 |
| USE_YN | VARCHAR2(1) | 사용여부 |

### TS_INS_WEEK_SUB 저장 구조

| GUBUN | 설명 | 데이터 |
|-------|------|--------|
| `SHIP_STAT` | 요약 통계 | 지난주/누계 출하 요약 |
| `SHIP_ROW` | 크로스탭 행 | 13개 항목 × 7일 데이터 |
| `SHIP_CHART` | 분석 차트용 | 일별 출하두수/체중/등지방 |
| `SHIP_SCATTER` | 산점도용 | 도체중 × 등지방 × 두수 |

### SHIP_STAT (요약 통계, 1행)

| 컬럼 | 설명 |
|------|------|
| CNT_1 | 지난주 출하두수 |
| CNT_2 | 당해년도 누계 출하두수 |
| CNT_3 | 지난주 1등급↑ 합격두수 |
| VAL_1 | 1등급↑ 합격율(%) |
| VAL_2 | 평균 도체중(kg) |
| VAL_3 | 평균 등지방(mm) |

### SHIP_ROW (크로스탭 테이블, 13행)

| SORT_NO | 항목 | CNT_1~7 | VAL_1 | VAL_2 | VAL_3 | CODE_1 |
|---------|------|---------|-------|-------|-------|--------|
| 1 | 출하두수 | 일별 두수 | 합계 | - | 일평균 두수 | BUT_CNT |
| 2 | 이유두수 | 일별 두수 | 합계 | - | 일평균 두수 | EU_DUSU |
| 3 | 육성율(%) | 일별 비율 | - | - | 평균(%) | EU_RATIO |
| 4 | 1등급↑ 합격율 | 일별 비율 | - | - | 평균(%) | ONE_RATIO |
| 5 | 1+ 등급 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | Q_11 |
| 6 | 1 등급 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | Q_1 |
| 7 | 2 등급 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | Q_2 |
| 8 | 암 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | FEMALE |
| 9 | 수 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | MALE |
| 10 | 거세 | 일별 두수 | 합계 | 비율(%) | 일평균 두수 | ETC |
| 11 | 총지육(kg) | 일별 kg | 합계 | - | 일평균 kg | TNET_KG |
| 12 | 평균 지육체중(kg) | 일별 평균 | - | - | 전체평균 | AVG_NET |
| 13 | 평균 등지방(mm) | 일별 평균 | - | - | 전체평균 | AVG_BACK |

- `STR_1~7`: 일별 날짜 (MM.DD)
- `CNT_1~7`: 일별 값
- `VAL_1`: 합계
- `VAL_2`: 비율(%) - 등급/성별 행만
- `VAL_3`: 평균
- `CODE_1`: 항목코드 (프론트에서 하이라이트 판단용)

### SHIP_CHART (분석 차트, 7행)

| 컬럼 | 설명 |
|------|------|
| STR_1 | 날짜 (MM.DD) |
| CNT_1 | 출하두수 |
| VAL_1 | 평균 지육체중(kg) |
| VAL_2 | 평균 등지방(mm) |

### SHIP_SCATTER (산점도, N행)

| 컬럼 | 설명 |
|------|------|
| VAL_1 | 도체중(kg) - X축 |
| VAL_2 | 등지방(mm) - Y축 |
| CNT_1 | 두수 - 라벨 |

---

## 3. 원본 테이블 참조

### TM_LPD_DATA (도축 출하 데이터)
- **DOCHUK_DT**: VARCHAR2(10), 도축일 (YYYY-MM-DD 형식, 문자열)
- **NET_KG**: 지육체중(도체중) kg
- **BACK_DEPTH**: 등지방두께 mm
- **MEAT_QUALITY**: 육질등급 ('1+', '1', '2', '등외')
- **SEX_GUBUN**: 성별구분 ('F'=암, 'M'=수, 기타=거세)

### TB_EU (이유 데이터) - 육성율 계산용
- **WK_DT**: CHAR(8), 작업일 (YYYYMMDD 형식)
- **DUSU**: 이유두수 (수컷)
- **DUSU_SU**: 이유두수 (암컷)
- 총 이유두수 = DUSU + DUSU_SU

> **주의**: TM_LPD_DATA.DOCHUK_DT는 VARCHAR2 'YYYY-MM-DD' 형식, TB_EU.WK_DT는 CHAR(8) 'YYYYMMDD' 형식으로 다름

---

## 4. TS_INS_WEEK 메인 테이블 업데이트

| 컬럼 | 설명 |
|------|------|
| LAST_SH_CNT | 지난주 출하두수 |
| LAST_SH_SUM | 당해년도 출하두수 누계 |
| LAST_SH_AVG_KG | 평균 지육체중(kg) |
| LAST_SH_AVG_SUM | 당해년도 평균 지육체중 |

---

## 5. 프론트엔드 연동

### API 응답 구조

```typescript
interface ShipmentPopupData {
  // 요약 통계
  stats: {
    totalCount: number;      // 지난주 출하두수
    yearTotal: number;       // 당해년도 누계
    grade1Rate: number;      // 1등급↑ 합격율(%)
    avgCarcass: number;      // 평균 지육체중(kg)
    avgBackfat: number;      // 평균 등지방(mm)
  };
  // 등급별 차트 (1+, 1, 2, 등외)
  gradeChart: {
    name: string;
    value: number;
    color: string;
    colorEnd: string;
  }[];
  // 크로스탭 테이블
  table: {
    days: string[];          // ['11.18', '11.19', ...]
    rows: TableRow[];        // 13개 행
  };
  // 분석 차트
  analysisChart: {
    dates: string[];
    shipCount: number[];
    avgWeight: number[];
    avgBackfat: number[];
  };
  // 산점도
  carcassChart: {
    data: number[][];        // [[도체중, 등지방, 두수], ...]
  };
}
```

### 하이라이트 행

| CODE_1 | 항목 | 스타일 |
|--------|------|--------|
| BUT_CNT | 출하두수 | primary (파란색) |
| AVG_NET | 평균 지육체중 | success (녹색) |
| AVG_BACK | 평균 등지방 | success (녹색) |

---

## 6. 참고

- 출하 데이터 소스: `TM_LPD_DATA` (도축장 연동 데이터)
- 육성율 = 출하두수 / (N일 전 이유두수) × 100 (N ≈ 160일)
- 등급: 1+, 1, 2, 등외 (MEAT_QUALITY 컬럼)
- 성별: 암, 수, 거세 (SEX_GUBUN 컬럼)
- 박피/탕박 구분은 TM_LPD_DATA에 해당 컬럼 없어 제외됨
