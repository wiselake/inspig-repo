# 주간 리포트 프로세스

> 주간 리포트 생성 프로세스 상세

---

## 1. 실행 흐름

```
┌─────────────────────────────────────────────────────────────┐
│  JOB_INS_WEEKLY_REPORT (매주 월 02:00 KST)                  │
│  [99_JOB_INS_WEEKLY.sql]                                    │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  SP_INS_WEEK_MAIN (P_DAY_GB, P_BASE_DT, P_PARALLEL, P_TEST) │
│  [01_SP_INS_WEEK_MAIN.sql]                                  │
└─────────────────────────┬───────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
    ┌───────────┐   ┌───────────┐   ┌───────────┐
    │ STEP 1    │   │ STEP 2    │   │ STEP 3    │
    │ MASTER    │   │ 농장조회  │   │ 농장루프  │
    │ INSERT    │   │           │   │           │
    └───────────┘   └───────────┘   └─────┬─────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────┐
│  SP_INS_WEEK_FARM_PROCESS (농장별 처리)                     │
│  [01_SP_INS_WEEK_MAIN.sql 내 서브프로시저]                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. TS_INS_WEEK INSERT (농장 요약)                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 2. 팝업 프로시저 순차 호출                          │   │
│  │                                                     │   │
│  │    SP_INS_WEEK_MODON_POPUP  ──▶ GUBUN='MODON'       │   │
│  │    SP_INS_WEEK_ALERT_POPUP  ──▶ GUBUN='ALERT'       │   │
│  │    SP_INS_WEEK_GB_POPUP     ──▶ GUBUN='GB_*'        │   │
│  │    SP_INS_WEEK_BM_POPUP     ──▶ GUBUN='BM_*'        │   │
│  │    SP_INS_WEEK_EU_POPUP     ──▶ GUBUN='EU_*'        │   │
│  │    SP_INS_WEEK_SG_POPUP     ──▶ GUBUN='SG*'         │   │
│  │    SP_INS_WEEK_DOPE_POPUP   ──▶ (예정)              │   │
│  │    SP_INS_WEEK_CH_POPUP     ──▶ (예정)              │   │
│  │    SP_INS_WEEK_SCHEDULE     ──▶ (예정)              │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                          ▼                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 3. COMPLETE_CNT 업데이트                            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  STEP 4. TS_INS_MASTER STATUS_CD = 'COMPLETE'               │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 프로시저 목록

### 메인 프로시저

| 프로시저 | 설명 | SQL 파일 |
|----------|------|----------|
| SP_INS_WEEK_MAIN | 메인 오케스트레이터 | [01_SP_INS_WEEK_MAIN.sql](../../sql/ins/week/01_SP_INS_WEEK_MAIN.sql) |
| SP_INS_WEEK_FARM_PROCESS | 농장별 처리 | 동일 파일 |
| SP_INS_WEEK_RETRY_ERROR | 오류 농장 재시도 | 동일 파일 |

### 데이터 추출 프로시저

| 프로시저 | GUBUN | 설명 | SQL 파일 | 문서 |
|----------|-------|------|----------|------|
| SP_INS_WEEK_MODON_POPUP | MODON | 모돈현황 팝업 | [11_SP_INS_WEEK_MODON_POPUP.sql](../../sql/ins/week/11_SP_INS_WEEK_MODON_POPUP.sql) | [01.modon-popup.md](01.modon-popup.md) |
| SP_INS_WEEK_ALERT_POPUP | ALERT | 관리대상 모돈 | [12_SP_INS_WEEK_ALERT_POPUP.sql](../../sql/ins/week/12_SP_INS_WEEK_ALERT_POPUP.sql) | [12.alert-popup.md](12.alert-popup.md) |
| SP_INS_WEEK_GB_POPUP | GB_LIST, GB_STAT, GB_CHART | 교배 팝업 | [21_SP_INS_WEEK_GB_POPUP.sql](../../sql/ins/week/21_SP_INS_WEEK_GB_POPUP.sql) | [21.gb-popup.md](21.gb-popup.md) |
| SP_INS_WEEK_BM_POPUP | BM_LIST, BM_STAT | 분만 팝업 | [22_SP_INS_WEEK_BM_POPUP.sql](../../sql/ins/week/22_SP_INS_WEEK_BM_POPUP.sql) | (예정) |
| SP_INS_WEEK_EU_POPUP | EU_LIST, EU_STAT | 이유 팝업 | [23_SP_INS_WEEK_EU_POPUP.sql](../../sql/ins/week/23_SP_INS_WEEK_EU_POPUP.sql) | [23.eu-popup.md](23.eu-popup.md) |
| SP_INS_WEEK_SG_POPUP | SG, SG_CHART | 사고 팝업 | [31_SP_INS_WEEK_SG_POPUP.sql](../../sql/ins/week/31_SP_INS_WEEK_SG_POPUP.sql) | [31.sg-popup.md](31.sg-popup.md) |
| SP_INS_WEEK_DOPE_POPUP | DOPE, DOPE_R, DOPE_CHART | 도태폐사 팝업 | [32_SP_INS_WEEK_DOPE_POPUP.sql](../../sql/ins/week/32_SP_INS_WEEK_DOPE_POPUP.sql) | [32.culling-popup.md](32.culling-popup.md) |
| SP_INS_WEEK_CH_POPUP | CH_LIST, CH_STAT | 출하 팝업 | (예정) | - |
| SP_INS_WEEK_SCHEDULE | SCHEDULE | 작업예정 | (예정) | - |

---

## 3. 파라미터

### SP_INS_WEEK_MAIN

| 파라미터 | 타입 | 설명 | 기본값 |
|----------|------|------|--------|
| P_DAY_GB | VARCHAR2 | WEEK/MON/QT | WEEK |
| P_BASE_DT | DATE | 기준일 | NULL (현재일) |
| P_PARALLEL | INTEGER | 병렬 처리 수 | 4 |
| P_TEST_YN | VARCHAR2 | 테스트 모드 | N |

### 테스트 실행

```sql
-- 테스트 모드 (금주 데이터, 오늘 포함)
EXEC SP_INS_WEEK_MAIN('WEEK', NULL, 4, 'Y');

-- 특정 기준일
EXEC SP_INS_WEEK_MAIN('WEEK', TO_DATE('20241208', 'YYYYMMDD'), 4, 'Y');
```

---

## 4. 기간 계산

| 구분 | 계산 방식 |
|------|----------|
| P_TEST_YN='N' | 전주 월~일 (TRUNC(SYSDATE, 'IW') - 7 ~ -1) |
| P_TEST_YN='Y' | 금주 월~오늘 (TRUNC(SYSDATE, 'IW') ~ SYSDATE) |

---

## 5. 로그 확인

```sql
-- 실행 현황
SELECT SEQ, DAY_GB, DT_FROM, DT_TO, TARGET_CNT, COMPLETE_CNT, ERROR_CNT, STATUS_CD
FROM TS_INS_MASTER
ORDER BY SEQ DESC;

-- 프로시저별 로그
SELECT PROC_NM, FARM_NO, STATUS_CD, PROC_CNT, START_DT, END_DT, ERROR_MSG
FROM TS_INS_JOB_LOG
WHERE MASTER_SEQ = :masterSeq
ORDER BY SEQ;
```

---

## 6. 스케줄러 JOB

- [99_JOB_INS_WEEKLY.sql](../../sql/ins/week/99_JOB_INS_WEEKLY.sql)

```sql
-- JOB 상태 확인
SELECT JOB_NAME, STATE, ENABLED, NEXT_RUN_DATE
FROM USER_SCHEDULER_JOBS
WHERE JOB_NAME = 'JOB_INS_WEEKLY_REPORT';

-- 즉시 실행 (테스트)
EXEC DBMS_SCHEDULER.RUN_JOB('JOB_INS_WEEKLY_REPORT');
```

---

## 7. DB 반영 SQL 목록

### 실행 순서

```
1. 공통
   └── sql/ins/01_SEQUENCE.sql          -- 시퀀스 생성
   └── sql/ins/02_TABLE.sql             -- 테이블 생성
   └── sql/ins/11_SP_INS_COM_LOG.sql    -- 공통 로그 프로시저

2. 주간 리포트
   └── sql/ins/week/01_SP_INS_WEEK_MAIN.sql        -- 메인 프로시저
   └── sql/ins/week/11_SP_INS_WEEK_MODON_POPUP.sql -- 모돈현황 팝업
   └── sql/ins/week/12_SP_INS_WEEK_ALERT_POPUP.sql -- 관리대상 모돈
   └── sql/ins/week/21_SP_INS_WEEK_GB_POPUP.sql    -- 교배 팝업
   └── sql/ins/week/22_SP_INS_WEEK_BM_POPUP.sql    -- 분만 팝업
   └── sql/ins/week/23_SP_INS_WEEK_EU_POPUP.sql    -- 이유 팝업
   └── sql/ins/week/31_SP_INS_WEEK_SG_POPUP.sql    -- 사고 팝업
   └── sql/ins/week/32_SP_INS_WEEK_DOPE_POPUP.sql  -- 도태폐사 팝업
   └── sql/ins/week/99_JOB_INS_WEEKLY.sql          -- 스케줄러 JOB
```

### SQL 파일 목록

| 순서 | 파일 | 설명 | 비고 |
|------|------|------|------|
| 1 | [01_SEQUENCE.sql](../../sql/ins/01_SEQUENCE.sql) | 시퀀스 생성 | 최초 1회 |
| 2 | [02_TABLE.sql](../../sql/ins/02_TABLE.sql) | 테이블 생성 | 최초 1회 |
| 3 | [11_SP_INS_COM_LOG.sql](../../sql/ins/11_SP_INS_COM_LOG.sql) | 공통 로그 프로시저 | |
| 4 | [01_SP_INS_WEEK_MAIN.sql](../../sql/ins/week/01_SP_INS_WEEK_MAIN.sql) | 메인 프로시저 | |
| 5 | [11_SP_INS_WEEK_MODON_POPUP.sql](../../sql/ins/week/11_SP_INS_WEEK_MODON_POPUP.sql) | 모돈현황 팝업 | |
| 6 | [12_SP_INS_WEEK_ALERT_POPUP.sql](../../sql/ins/week/12_SP_INS_WEEK_ALERT_POPUP.sql) | 관리대상 모돈 | |
| 7 | [21_SP_INS_WEEK_GB_POPUP.sql](../../sql/ins/week/21_SP_INS_WEEK_GB_POPUP.sql) | 교배 팝업 | |
| 8 | [22_SP_INS_WEEK_BM_POPUP.sql](../../sql/ins/week/22_SP_INS_WEEK_BM_POPUP.sql) | 분만 팝업 | |
| 9 | [23_SP_INS_WEEK_EU_POPUP.sql](../../sql/ins/week/23_SP_INS_WEEK_EU_POPUP.sql) | 이유 팝업 | |
| 10 | [31_SP_INS_WEEK_SG_POPUP.sql](../../sql/ins/week/31_SP_INS_WEEK_SG_POPUP.sql) | 사고 팝업 | |
| 11 | [32_SP_INS_WEEK_DOPE_POPUP.sql](../../sql/ins/week/32_SP_INS_WEEK_DOPE_POPUP.sql) | 도태폐사 팝업 | |
| 12 | [99_JOB_INS_WEEKLY.sql](../../sql/ins/week/99_JOB_INS_WEEKLY.sql) | 스케줄러 JOB | 마지막 |
