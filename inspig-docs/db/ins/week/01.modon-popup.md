# 모돈현황 팝업 (SP_INS_WEEK_MODON_POPUP)

> 산차별 x 상태별 모돈 현황 교차표

---

## 1. 데이터 구조

### 원본 vs 저장 구조

| 구분 | 행 | 열 |
|------|-----|-----|
| 원본 SQL | 상태별 | 산차별 |
| 저장 구조 | 산차별 | 상태별 |

x,y축 피벗 변환

### TS_INS_WEEK_SUB 컬럼 매핑

| 컬럼 | 설명 | 값 |
|------|------|-----|
| GUBUN | 구분 | 'MODON' |
| CODE_1 | 산차 | 후보돈, 0산~7산, 8산+ |
| CNT_1 | 후보 | STATUS_CD='010001' |
| CNT_2 | 임신 | STATUS_CD='010002' |
| CNT_3 | 포유 | STATUS_CD IN ('010003','010004') |
| CNT_4 | 이유모 | STATUS_CD='010005' |
| CNT_5 | 사고 | STATUS_CD IN ('010006','010007') |
| CNT_6 | 증감 | 이전 주차 대비 산차별 증감 |

---

## 2. 산차 구분

| 산차 | 조건 | SORT_NO |
|------|------|---------|
| 후보돈 | SANCHA=0 AND STATUS='010001' | 1 |
| 0산 | SANCHA=0 | 2 |
| 1산 | SANCHA=1 | 3 |
| ... | ... | ... |
| 7산 | SANCHA=7 | 9 |
| 8산+ | SANCHA>=8 | 10 |

---

## 3. 상태 결정 로직

### 작업이력 없는 모돈

- 산차=0, 교배차수=1, 상태=임신돈 -> 후보돈으로 전환
- 그 외: 전입 상태코드 사용

### 작업이력 있는 모돈

`SF_GET_MODONGB_STATUS` 함수 호출
- [03.function.md](../../ref/03.function.md) 참조

---

## 4. 최적화 전략

- TB_MODON을 드라이빙 테이블로 사용
- TB_MODON_WK는 기준일 이전 마지막 작업만 추출
- 인덱스 힌트: `/*+ INDEX(WK IDX_MODON_WK_03) */`

---

## 5. 합계두수 및 증감 처리

### TS_INS_WEEK 테이블 업데이트

| 컬럼 | 설명 |
|------|------|
| MODON_REG_CNT | 현재모돈 합계 (산차별 합계두수) |
| MODON_CHG_CNT | 전주 대비 증감 (이전 주차 MODON_REG_CNT 대비) |

### 증감 계산 로직

1. TS_INS_MASTER에서 이전 주차 MASTER_SEQ 조회 (STATUS_CD='COMPLETE')
2. 이전 주차 TS_INS_WEEK_SUB (GUBUN='MODON') 데이터와 비교
3. 산차별(CODE_1) CNT_6 = (현재 합계) - (이전 합계)
4. 이전 주차 데이터 없으면 CNT_6 = 현재 합계 (첫 주)

---

## SQL 참조

- [11_SP_INS_WEEK_MODON_POPUP.sql](../../sql/ins/week/11_SP_INS_WEEK_MODON_POPUP.sql)
