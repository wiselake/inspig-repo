# 관리대상 모돈 팝업 (SP_INS_WEEK_ALERT_POPUP)

> 미교배, 분만지연, 이유지연 등 관리대상 모돈 추출

---

## 1. 데이터 구조

### TS_INS_WEEK_SUB GUBUN 코드

| GUBUN | 설명 |
|-------|------|
| ALERT | 관리대상 모돈 기간별 집계 |

---

## 2. ALERT 컬럼 매핑

| 컬럼 | 설명 | 값/예시 |
|------|------|---------|
| CODE_1 | 지연 기간 | '~3', '4~7', '8~14', '14~' |
| CNT_1 | 미교배 후보돈 | NOT_GY_HUBO |
| CNT_2 | 이유후 미교배 | NOT_GY_EU |
| CNT_3 | 사고후 미교배 | NOT_GY_SG |
| CNT_4 | 분만지연 | NOT_BM_GY |
| CNT_5 | 이유지연 | NOT_EU_BM |

### SORT_NO 정의

| SORT_NO | CODE_1 | 설명 |
|---------|--------|------|
| 1 | ~3 | 지연 0~3일 |
| 2 | 4~7 | 지연 4~7일 |
| 3 | 8~14 | 지연 8~14일 |
| 4 | 14~ | 지연 14일 초과 |

---

## 3. 관리대상 유형

### 3.1 미교배 후보돈 (NOT_GY_HUBO)

| 항목 | 내용 |
|------|------|
| 조건 | STATUS_CD='010001', 작업이력 없음 |
| 지연일 | (기준일 - 출생일) - 초교배일령(140007) |
| 기준값 | 후보돈초교배일령 (TC_FARM_CONFIG.CODE='140007', 기본 240일) |

```sql
-- 지연일 >= 0인 후보돈
WHERE STATUS_CD = '010001'  -- 후보돈
  AND (V_BASE_DT - BIRTH_DT) - V_FIRST_GB_DAY >= 0
  AND NOT EXISTS (SELECT 1 FROM TB_MODON_WK ...)
```

### 3.2 이유후 미교배 (NOT_GY_EU)

| 항목 | 내용 |
|------|------|
| 조건 | WK_GUBUN='E', DAERI_YN='N' (대리돈 제외) |
| 지연일 | (기준일 - 이유일) - 평균재귀일 + 1 |
| 기준값 | 평균재귀일 (TC_FARM_CONFIG.CODE='140008', 기본 7일) |

```sql
-- 작업이력 있는 이유돈
WHERE WK_GUBUN = 'E' AND DAERI_YN = 'N'
  AND (V_BASE_DT - TO_DATE(WK_DT)) + 1 >= V_AVG_RETURN

-- 전입 이유돈 (작업이력 없음)
WHERE STATUS_CD = '010005'  -- 이유돈
  AND NOT EXISTS (SELECT 1 FROM TB_MODON_WK ...)
```

### 3.3 사고후 미교배 (NOT_GY_SG)

| 항목 | 내용 |
|------|------|
| 조건 | WK_GUBUN='F' |
| 지연일 | (기준일 - 사고일) |

```sql
-- 작업이력 있는 사고돈
WHERE WK_GUBUN = 'F'
  AND (V_BASE_DT - TO_DATE(WK_DT)) >= 0

-- 전입 사고돈 (작업이력 없음)
WHERE STATUS_CD IN ('010006', '010007')  -- 재발돈, 공태돈
  AND NOT EXISTS (SELECT 1 FROM TB_MODON_WK ...)
```

### 3.4 분만지연 (NOT_BM_GY)

| 항목 | 내용 |
|------|------|
| 조건 | WK_GUBUN='G' (최종 작업이 교배) |
| 지연일 | (기준일 - 교배일) - 평균임신기간 |
| 기준값 | 평균임신기간 (TC_FARM_CONFIG.CODE='140002', 기본 115일) |

```sql
WHERE WK_GUBUN = 'G'  -- 최종 교배
  AND (V_BASE_DT - TO_DATE(WK_DT)) - V_PREG_PERIOD >= 0
```

### 3.5 이유지연 (NOT_EU_BM)

| 항목 | 내용 |
|------|------|
| 조건 | WK_GUBUN='B' (최종 작업이 분만) |
| 지연일 | (기준일 - 분만일) - 평균포유기간 |
| 기준값 | 평균포유기간 (TC_FARM_CONFIG.CODE='140003', 기본 21일) |

```sql
WHERE WK_GUBUN = 'B'  -- 최종 분만
  AND (V_BASE_DT - TO_DATE(WK_DT)) - V_WEAN_PERIOD >= 0
```

---

## 4. 농장 설정값

| 코드 | 설명 | 기본값 |
|------|------|--------|
| 140002 | 평균임신기간 | 115일 |
| 140003 | 평균포유기간 | 21일 |
| 140007 | 후보돈초교배일령 | 240일 |
| 140008 | 평균재귀일 | 7일 |

```sql
SELECT CODE, CVALUE
FROM TC_FARM_CONFIG
WHERE FARM_NO = P_FARM_NO
  AND CODE IN ('140002', '140003', '140007', '140008');
```

---

## 5. TS_INS_WEEK 업데이트

| 컬럼 | 설명 |
|------|------|
| ALERT_TOTAL | 전체 관리대상 합계 |
| ALERT_HUBO | 미교배 후보돈 합계 |
| ALERT_EU_MI | 이유후 미교배 합계 |
| ALERT_SG_MI | 사고후 미교배 합계 |
| ALERT_BM_DELAY | 분만지연 합계 |
| ALERT_EU_DELAY | 이유지연 합계 |

---

## 6. 필수 조건 (공통)

모든 쿼리에 적용되는 공통 조건:

```sql
WHERE OUT_DT = TO_DATE('9999-12-31', 'YYYY-MM-DD')  -- 미도폐사 모돈
  AND USE_YN = 'Y'
```

---

## SQL 참조

- [12_SP_INS_WEEK_ALERT_POPUP.sql](../../sql/ins/week/12_SP_INS_WEEK_ALERT_POPUP.sql)
