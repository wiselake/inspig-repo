# 도태폐사 팝업 (SP_INS_WEEK_DOPE_POPUP)

> 유형별 스탯바 + 원인별 테이블 + 상태별 차트

---

## 1. 데이터 구조

### TS_INS_WEEK_SUB GUBUN 코드

| GUBUN | SORT_NO | 설명 |
|-------|---------|------|
| DOPE | 1 | 유형별 통계 (도태/폐사/전출/판매) - 지난주 (1행) |
| DOPE | 2 | 유형별 통계 - 최근1개월 + 당해년도 누계 (1행) |
| DOPE_R_1, DOPE_R_2, ... | 1 | 원인별 통계 - 지난주+최근1개월 병합, 15개씩 피벗 |
| DOPE_CHART | 1 | 상태별(STATUS_NM) 차트 데이터 (1행) |

---

## 2. 유형 4개 (OUT_GUBUN_CD - PCODE='08')

| CNT 컬럼 | 유형명 | 코드 | 비고 |
|----------|--------|------|------|
| CNT_1 | 도태 | 080001 | stats.dotae |
| CNT_2 | 폐사 | 080002 | stats.dead |
| CNT_3 | 전출 | 080003 | stats.transfer |
| CNT_4 | 판매 | 080004 | stats.sale |

### 유형코드 조회

```sql
-- TC_CODE_SYS에서 PCODE='08' 조회
SELECT CODE, CNAME
FROM TC_CODE_SYS
WHERE PCODE = '08'
  AND LANGUAGE_CD = 'ko'
ORDER BY SORT_NO;
```

---

## 3. DOPE 컬럼 매핑 (유형별 스탯바)

| SORT_NO | 설명 | CNT_1~CNT_4 | VAL_1~VAL_4 | CNT_5 | VAL_5 |
|---------|------|-------------|-------------|-------|-------|
| 1 | 지난주 | 유형별 두수 | 비율 (%) | - | - |
| 2 | 최근1개월 | 유형별 두수 | 비율 (%) | 당해년도 누계 | - |

- 기간:
  - SORT_NO=1: P_DT_FROM ~ P_DT_TO (지난주)
  - SORT_NO=2 CNT_1~CNT_4: P_DT_FROM - 30일 ~ P_DT_TO (최근1개월, 팝업용)
  - SORT_NO=2 CNT_5: 당해년도 1/1 ~ P_DT_TO (당해년도 누계, sec-lastweek 카드용)
- 비율: 각 유형별 두수 / 전체 합계 * 100 (소수점 1자리)

---

## 4. DOPE_R 컬럼 매핑 (원인별 테이블)

> 지난주+최근1개월 원인코드를 병합하여 존재하는 것만 표출

| GUBUN | 컬럼 | 설명 |
|-------|------|------|
| DOPE_R_1 | STR_1~STR_15 | 원인코드 (OUT_REASON_CD) 1~15번째 |
| DOPE_R_1 | CNT_1~CNT_15 | **지난주** 두수 |
| DOPE_R_1 | VAL_1~VAL_15 | **최근1개월** 두수 |
| DOPE_R_2 | STR_1~STR_15 | 원인코드 16~30번째 |
| ... | ... | ... |

- 정렬: 최근1개월 두수 내림차순 → 지난주 두수 내림차순
- 15개씩 나눠서 저장 (모든 원인 기록)
- STR_N에 원인코드 저장 (NULL이면 해당 슬롯 비어있음)
- **프론트에서 TC_CODE_JOHAP으로 코드명 조회**

### 원인코드 → 코드명 조회 (프론트)

```sql
-- TC_CODE_JOHAP에서 PCODE='031' 조회
SELECT CODE, CNAME
FROM TC_CODE_JOHAP
WHERE PCODE = '031'
  AND LANGUAGE_CD = 'ko';
```

---

## 5. DOPE_CHART 컬럼 매핑 (상태별 차트)

> STATUS_NM (PCODE='01') 기준 - 값이 없어도 모두 표시

| CNT 컬럼 | 상태명 | 코드 | 비고 |
|----------|--------|------|------|
| CNT_1 | 후보돈 | 010001 | |
| CNT_2 | 이유모돈 | 010002 | |
| CNT_3 | 임신돈 | 010003 | |
| CNT_4 | 포유돈 | 010004 | |
| CNT_5 | 사고돈 | 010005 | |
| CNT_6 | 비생산돈 | 010006 | |

- 기간: P_DT_FROM ~ P_DT_TO (지난주)
- 값이 0이어도 모든 상태 포함

### 상태코드 조회

```sql
-- TC_CODE_SYS에서 PCODE='01' 조회
SELECT CODE, CNAME
FROM TC_CODE_SYS
WHERE PCODE = '01'
  AND LANGUAGE_CD = 'ko'
ORDER BY SORT_NO;
```

---

## 6. TS_INS_WEEK 업데이트

| 컬럼 | 값 | 설명 |
|------|-----|------|
| LAST_CL_CNT | SUM(CNT_1~CNT_4) from DOPE SORT_NO=1 | 지난주 도폐사 합계 |
| LAST_CL_SUM | CNT_5 from DOPE SORT_NO=2 | 당해년도 도폐사 누계 |

---

## 7. 프론트엔드 매핑

### CullingPopupData → DOPE, DOPE_R, DOPE_CHART

```typescript
interface CullingPopupData {
  // 유형별 스탯바 (DOPE SORT_NO=1)
  stats: {
    dotae: number;      // CNT_1
    dead: number;       // CNT_2
    transfer: number;   // CNT_3
    sale: number;       // CNT_4
  };
  // 원인별 테이블 (DOPE_R) - 1행 피벗 구조에서 변환
  table: CullingTableRow[];
  // 상태별 차트 (DOPE_CHART) - 두 번째 탭
  chart: {
    xAxis: string[];    // ['후보돈', '이유모돈', '임신돈', '포유돈', '사고돈', '비생산돈']
    data: number[];     // CNT_1~CNT_6
  };
}

interface CullingTableRow {
  reasonCd: string;     // STR_N (OUT_REASON_CD) - 원인코드
  reason: string;       // TC_CODE_JOHAP.CNAME에서 조회한 코드명
  cnt: number;          // CNT_N - 두수
}

// 지난주 탭: GUBUN LIKE 'DOPE_R_W_%' 조회 → CullingTableRow[] 변환
// 최근1개월 탭: GUBUN LIKE 'DOPE_R_M_%' 조회 → CullingTableRow[] 변환
//
// 변환 로직:
// 1. 해당 GUBUN 패턴으로 모든 행 조회
// 2. 각 행에서 STR_1~STR_15, CNT_1~CNT_15 추출
// 3. STR_N이 NULL이 아닌 경우만 배열에 추가
// 4. TC_CODE_JOHAP(PCODE='031')에서 코드명 조회하여 reason에 설정
```

---

## 8. 데이터 소스

### VW_MODON_2020_MAX_WK_02 (도폐사/판매대장 뷰)

```sql
SELECT
    WK.FARM_PIG_NO,
    WK.OUT_DT,
    MD.OUT_GUBUN_CD,
    MD.OUT_REASON_CD,
    WK.STATUS_CODE
FROM VW_MODON_2020_MAX_WK_02 WK
INNER JOIN TB_MODON MD
    ON WK.FARM_NO = MD.FARM_NO
   AND WK.PIG_NO = MD.PIG_NO
WHERE WK.FARM_NO = :farmNo
  AND WK.OUT_DT >= TO_DATE(:dtFrom, 'YYYYMMDD')
  AND WK.OUT_DT <= TO_DATE(:dtTo, 'YYYYMMDD')
  AND WK.OUT_GUBUN_CD IN ('080001', '080002')  -- 도태, 폐사만 (sec-lastweek)
```

---

## 9. 조회 쿼리

### 유형별 스탯바

```sql
SELECT CNT_1, CNT_2, CNT_3, CNT_4
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq
  AND FARM_NO = :farmNo
  AND GUBUN = 'DOPE'
  AND SORT_NO = 1;
```

### 원인별 테이블 (병합)

```sql
-- 모든 원인 조회 (지난주+최근1개월 병합)
SELECT
    GUBUN,
    STR_1, STR_2, ..., STR_15,   -- 원인코드
    CNT_1, CNT_2, ..., CNT_15,   -- 지난주 두수
    VAL_1, VAL_2, ..., VAL_15    -- 최근1개월 두수
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq
  AND FARM_NO = :farmNo
  AND GUBUN LIKE 'DOPE_R_%'
ORDER BY GUBUN;
```

### 상태별 차트

```sql
SELECT CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq
  AND FARM_NO = :farmNo
  AND GUBUN = 'DOPE_CHART';
```

---

## SQL 참조

- [32_SP_INS_WEEK_DOPE_POPUP.sql](../../sql/ins/week/32_SP_INS_WEEK_DOPE_POPUP.sql)
