# 임신사고 팝업 (SP_INS_WEEK_SG_POPUP)

> 원인별 사고복수 테이블 + 임신일별 사고복수 차트

---

## 1. 데이터 구조

### TS_INS_WEEK_SUB GUBUN 코드

| GUBUN | SORT_NO | 설명 |
|-------|---------|------|
| SG | 1 | 지난주 원인별 사고복수 (1행) |
| SG | 2 | 최근1개월 원인별 사고복수 + 당해년도 누계 (1행) |
| SG_CHART | 1 | 임신일별 사고복수 차트 (1행) |

---

## 2. 사고구분 8개 유형 (CNT_1 ~ CNT_8)

| CNT 컬럼 | 사고구분명 | 코드 | 비고 |
|----------|-----------|------|------|
| CNT_1 | 재발 | 050008 | |
| CNT_2 | 불임 | 050009 | |
| CNT_3 | 공태 | 050007 | |
| CNT_4 | 유산 | 050002 | |
| CNT_5 | 도태 | 050003 | |
| CNT_6 | 폐사 | 050004 | |
| CNT_7 | 임돈전출 | 050005 | 차트 제외 |
| CNT_8 | 임돈판매 | 050006 | 차트 제외 |

---

## 3. SG 컬럼 매핑 (원인별 테이블)

| SORT_NO | 설명 | CNT_1~CNT_8 | VAL_1~VAL_8 | CNT_9 | VAL_9 |
|---------|------|-------------|-------------|-------|-------|
| 1 | 지난주 | 사고구분별 사고복수 | 비율 (%) | - | 지난주 평균경과일 |
| 2 | 최근1개월 | 사고구분별 사고복수 | 비율 (%) | 당해년도 누계 | 당해년도 평균경과일 |

- 기간:
  - SORT_NO=1: P_DT_FROM ~ P_DT_TO (지난주)
  - SORT_NO=2 CNT_1~CNT_8: P_DT_FROM - 30일 ~ P_DT_TO (최근1개월, 팝업용)
  - SORT_NO=2 CNT_9: 당해년도 1/1 ~ P_DT_TO (당해년도 누계, sec-lastweek 카드용)
  - SORT_NO=2 VAL_9: 당해년도 1/1 ~ P_DT_TO (당해년도 평균경과일, sec-lastweek 카드용)
- 비율: 각 사고구분별 복수 / 전체 합계 * 100 (소수점 1자리)
- 평균경과일: 임돈전출/판매 제외, 소수점 1자리

### 사고구분 조회

```sql
-- TC_CODE_SYS에서 PCODE='050000' 조회
SELECT CODE, CODE_NM
FROM TC_CODE_SYS
WHERE PCODE = '050000'
ORDER BY SORT_NO;
```

---

## 4. SG_CHART 컬럼 매핑 (임신일별 차트)

| CNT 컬럼 | 임신일 범위 | 조건 |
|----------|------------|------|
| CNT_1 | ~7 | <= 7 |
| CNT_2 | 8~10 | BETWEEN 8 AND 10 |
| CNT_3 | 11~15 | BETWEEN 11 AND 15 |
| CNT_4 | 16~20 | BETWEEN 16 AND 20 |
| CNT_5 | 21~35 | BETWEEN 21 AND 35 |
| CNT_6 | 36~40 | BETWEEN 36 AND 40 |
| CNT_7 | 41~45 | BETWEEN 41 AND 45 |
| CNT_8 | 46~ | >= 46 |

### 경과일 계산 (사고일 - 마지막 교배일)

```sql
-- 경과일 = 사고일 - 마지막 교배일 (사고 이전 가장 최근 교배)
-- 예: 교배 => 사고 => 교배 => 사고 시, 2번째 교배일 ~ 사고일
-- 예: 교배 => 사고 시, 첫번째 교배일 ~ 사고일
-- 이전 교배 기록이 없으면 TB_MODON.LAST_WK_DT를 fallback으로 사용
WK.WK_DATE - NVL(
    (SELECT MAX(GB.WK_DATE)
     FROM TB_MODON_WK GB
     WHERE GB.FARM_NO = WK.FARM_NO
       AND GB.PIG_NO = WK.PIG_NO
       AND GB.WK_GUBUN = 'G'  -- 교배
       AND GB.USE_YN = 'Y'
       AND GB.WK_DATE < WK.WK_DATE),  -- 사고일 이전
    MD.LAST_WK_DT  -- fallback: TB_MODON의 최종작업일
) AS GYUNGIL
```

> **참고**: 사고 이전에 가장 최근 교배일을 찾아 경과일을 계산합니다. 이전 교배 기록이 없는 경우 TB_MODON.LAST_WK_DT를 사용합니다.

---

## 5. TS_INS_WEEK 업데이트

| 컬럼 | 값 | 설명 |
|------|-----|------|
| LAST_SG_CNT | SUM(CNT_1~CNT_8) from SORT_NO=1 | 지난주 사고 합계 |
| LAST_SG_AVG_GYUNGIL | VAL_9 from SORT_NO=1 | 지난주 평균 경과일 |
| LAST_SG_SUM | CNT_9 from SORT_NO=2 | 당해년도 사고 누계 |
| LAST_SG_SUM_AVG_GYUNGIL | VAL_9 from SORT_NO=2 | 당해년도 평균 경과일 |

---

## 6. 프론트엔드 매핑

### AccidentPopupData → SG, SG_CHART

```typescript
interface AccidentPopupData {
  table: AccidentTableRow[];  // GUBUN='SG' 두 행 조합
  chart: {
    xAxis: string[];          // ['~7', '8~10', '11~15', '16~20', '21~35', '36~40', '41~45', '46~']
    data: number[];           // CNT_1~CNT_8 from SG_CHART
  };
}

interface AccidentTableRow {
  type: string;               // 사고구분명 (재발, 불임, ...)
  lastWeek: number;           // SORT_NO=1 row의 CNT_N
  lastWeekPct: number;        // SORT_NO=1 row의 VAL_N (비율 %)
  lastMonth: number;          // SORT_NO=2 row의 CNT_N
  lastMonthPct: number;       // SORT_NO=2 row의 VAL_N (비율 %)
}
```

---

## 7. 조회 쿼리

### 원인별 사고복수 테이블

```sql
-- 지난주 (SORT_NO=1)와 최근1개월 (SORT_NO=2)를 조회하여 조합
SELECT
    CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6, CNT_7, CNT_8,
    VAL_1, VAL_2, VAL_3, VAL_4, VAL_5, VAL_6, VAL_7, VAL_8
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq
  AND FARM_NO = :farmNo
  AND GUBUN = 'SG'
ORDER BY SORT_NO;
```

### 임신일별 사고복수 차트

```sql
SELECT CNT_1, CNT_2, CNT_3, CNT_4, CNT_5, CNT_6, CNT_7, CNT_8
FROM TS_INS_WEEK_SUB
WHERE MASTER_SEQ = :masterSeq
  AND FARM_NO = :farmNo
  AND GUBUN = 'SG_CHART';
```

---

## SQL 참조

- [31_SP_INS_WEEK_SG_POPUP.sql](../../sql/ins/week/31_SP_INS_WEEK_SG_POPUP.sql)
