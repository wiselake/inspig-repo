# 교배 팝업 (SP_INS_WEEK_GB_POPUP)

> 교배 리스트, 요약 통계, 재귀일별 차트

---

## 1. 데이터 구조

### TS_INS_WEEK_SUB GUBUN 코드

| GUBUN | 설명 |
|-------|------|
| GB_LIST | 교배 리스트 (개별 건) |
| GB_STAT | 교배 요약 통계 (1건) |
| GB_CHART | 재귀일별 교배복수 차트 |

---

## 2. GB_LIST 컬럼 매핑

| 컬럼 | 설명 | 값/예시 |
|------|------|---------|
| CODE_1 | 개체번호 | FARM_PIG_NO |
| CODE_2 | 이각번호 | IGAK_NO |
| STR_1 | 교배일 | YYYYMMDD |
| CNT_1 | 산차 | 0, 1, 2, ... |
| CNT_2 | 교배차 | 1, 2, 3, ... |
| STR_2 | 구분 | 'YN', 'NY', 'NN', 'YY' (후보+사고) |

### STR_2 해석

| 값 | 후보돈 | 사고돈 | 설명 |
|----|--------|--------|------|
| YN | Y | N | 후보돈 (초교배) |
| NY | N | Y | 경산돈 + 사고 후 재교배 |
| NN | N | N | 경산돈 정상 재교배 |
| YY | Y | Y | 후보돈 + 사고 후 재교배 (드문 케이스) |

---

## 3. GB_STAT 컬럼 매핑

| 컬럼 | 설명 | 비고 |
|------|------|------|
| CNT_1 | 합계 (실적) | 총 교배복수 |
| CNT_2 | 교배도중 사고복수 | 다음작업(SEQ+1)이 사고(F) |
| CNT_3 | 교배도중 분만복수 | 다음작업(SEQ+1)이 분만(B) |
| VAL_1 | 평균 재귀발정일 | 1차교배(GYOBAE_CNT=1)만, 교배일-이전작업일(SEQ-1) |
| VAL_2 | 평균 초교배일령 | 후보돈만 (출생~초교배 일수) |
| CNT_4 | 초교배복수 (실적) | 후보돈 교배 건수 |
| CNT_5 | 사고돈교배복수 (실적) | 이전작업(SEQ-1)이 사고(F) |
| CNT_6 | 이유돈교배복수 (실적) | 후보돈 아니고, 이전작업(SEQ-1)이 이유(E) |
| CNT_7 | 초교배 예정복수 | FN_MD_SCHEDULE_BSE_2020 (STATUS='010001') |
| CNT_8 | 정상교배 예정복수 | FN_MD_SCHEDULE_BSE_2020 (STATUS='010005') |
| CNT_9 | 재발교배 예정복수 | FN_MD_SCHEDULE_BSE_2020 (STATUS='010006','010007') |
| VAL_3 | 정상교배복수 | GYOBAE_CNT=1 (1차교배, 재발없음) |
| VAL_4 | 재발교배복수 | GYOBAE_CNT>1 (2차이상 교배) |

### 예정 데이터 조회 (FN_MD_SCHEDULE_BSE_2020)

```sql
-- 교배예정 조회 (P_SCHEDULE_GB='150005')
SELECT COUNT(*)
FROM TABLE(FN_MD_SCHEDULE_BSE_2020(
    P_FARM_NO,           -- 농장번호
    'JOB-DAJANG',        -- 리포트 구분
    '150005',            -- 교배예정
    P_STATUS_CODE,       -- 모돈상태 (010001, 010005, 010006, 010007)
    P_SDT,               -- 시작일 (yyyy-MM-dd)
    P_EDT,               -- 종료일 (yyyy-MM-dd)
    NULL,                -- 모돈그룹
    'ko',                -- 언어
    'yyyy-MM-dd',        -- 날짜포맷
    '-1',                -- SEQ (-1=전체)
    NULL                 -- 산차범위
));

-- 상태코드별 대상
-- 010001: 후보돈 (초교배 예정)
-- 010005: 이유돈 (정상교배 예정)
-- 010006: 재발돈 (재발교배 예정)
-- 010007: 공태돈 (재발교배 예정)
```

---

## 4. GB_CHART 컬럼 매핑 (재귀일별 교배복수)

| 컬럼 | 설명 | 값/예시 |
|------|------|---------|
| CODE_1 | 재귀일 구간 | '~7', '10', '15', ... '50', '50↑' |
| CNT_1 | 해당 구간 교배복수 | 건수 |
| SORT_NO | 정렬 순서 | 1~11 |

### 구간 정의

| SORT_NO | CODE_1 | 설명 |
|---------|--------|------|
| 1 | ~7 | 재귀일 7일 이하 |
| 2 | 10 | 재귀일 8~10일 |
| 3 | 15 | 재귀일 11~15일 |
| 4 | 20 | 재귀일 16~20일 |
| 5 | 25 | 재귀일 21~25일 |
| 6 | 30 | 재귀일 26~30일 |
| 7 | 35 | 재귀일 31~35일 |
| 8 | 40 | 재귀일 36~40일 |
| 9 | 45 | 재귀일 41~45일 |
| 10 | 50 | 재귀일 46~50일 |
| 11 | 50↑ | 재귀일 50일 초과 |

### 대상 데이터

- **경산돈만** 대상 (후보돈/초교배 제외)
- 재귀일 = 교배일 - 마지막 이유일

```sql
-- 후보돈 제외 조건
WHERE NOT (SANCHA = 0 AND GYOBAE_CNT = 1)

-- 재귀일 계산
TO_DATE(WK_DT, 'YYYYMMDD') - TO_DATE(LAST_EU_DT, 'YYYYMMDD')
```

---

## 5. 후보돈/사고돈 판별 기준

### 후보돈 (HUBO_YN = 'Y')

```sql
-- 후보돈 조건: TB_MODON 입식 시점 + TB_MODON_WK 이전 작업 이력 없음
-- 1. TB_MODON.IN_SANCHA = 0 (입식 시점 산차 0)
-- 2. TB_MODON.IN_GYOBAE_CNT = 0 (입식 시점 교배차 0)
-- 3. LEFT JOIN으로 이전 작업(SEQ-1) 조회 후 NULL 체크
CASE WHEN NVL(D.IN_SANCHA, 0) = 0 AND NVL(D.IN_GYOBAE_CNT, 0) = 0
          AND PW.SEQ IS NULL  -- 이전 작업이 없음
     THEN 'Y' ELSE 'N' END AS HUBO_YN
```

### 사고돈 (이전 작업이 사고)

```sql
-- 이전 작업(SEQ-1)이 사고(F)인 경우
(SELECT WK_GUBUN FROM TB_MODON_WK PW
 WHERE PW.FARM_NO = A.FARM_NO AND PW.PIG_NO = A.PIG_NO
   AND PW.SEQ = A.SEQ - 1 AND PW.USE_YN = 'Y'
) AS PREV_WK_GUBUN
-- PREV_WK_GUBUN = 'F' → 사고돈교배
```

### 이유돈 (이전 작업이 이유)

```sql
-- 후보돈 아니고, 이전 작업(SEQ-1)이 이유(E)인 경우
HUBO_YN = 'N' AND PREV_WK_GUBUN = 'E'
```

---

## 6. 통계 계산 로직

### 평균 재귀발정일 (VAL_1)

1차교배(GYOBAE_CNT=1)만 대상, 이전작업일(SEQ-1) ~ 교배일

```sql
-- 후보돈 제외, 1차교배만
AVG(
    CASE WHEN GYOBAE_CNT = 1 AND PREV_WK_DT IS NOT NULL AND HUBO_YN = 'N'
         THEN TO_DATE(WK_DT, 'YYYYMMDD') - TO_DATE(PREV_WK_DT, 'YYYYMMDD')
    END
)
```

### 평균 초교배일령 (VAL_2)

후보돈만 대상, 출생일 ~ 교배일

```sql
AVG(
    CASE WHEN HUBO_YN = 'Y'
         THEN TO_DATE(WK_DT, 'YYYYMMDD') - BIRTH_DT
    END
)
```

### 교배도중 사고/분만 (CNT_2, CNT_3)

다음작업(SEQ+1) 기준

```sql
-- 교배도중 사고복수: 다음 작업이 사고(F)
SELECT COUNT(*) FROM TB_MODON_WK A
LEFT JOIN TB_MODON_WK B
    ON B.FARM_NO = A.FARM_NO AND B.PIG_NO = A.PIG_NO
   AND B.SEQ = A.SEQ + 1 AND B.USE_YN = 'Y'
WHERE A.WK_GUBUN = 'G' AND B.WK_GUBUN = 'F';

-- 교배도중 분만복수: 다음 작업이 분만(B)
SELECT COUNT(*) FROM TB_MODON_WK A
LEFT JOIN TB_MODON_WK B
    ON B.FARM_NO = A.FARM_NO AND B.PIG_NO = A.PIG_NO
   AND B.SEQ = A.SEQ + 1 AND B.USE_YN = 'Y'
WHERE A.WK_GUBUN = 'G' AND B.WK_GUBUN = 'B';
```

---

## 7. TS_INS_WEEK 업데이트

| 컬럼 | 값 |
|------|-----|
| LAST_GB_CNT | 리스트 건수 (V_LIST_CNT) |

---

## SQL 참조

- [21_SP_INS_WEEK_GB_POPUP.sql](../../sql/ins/week/21_SP_INS_WEEK_GB_POPUP.sql)
