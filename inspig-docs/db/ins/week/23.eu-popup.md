# 이유 팝업 (SP_INS_WEEK_EU_POPUP)

> 이유 리스트, 요약 통계

---

## 1. 데이터 구조

### TS_INS_WEEK_SUB GUBUN 코드

| GUBUN | 설명 |
|-------|------|
| EU_LIST | 이유 리스트 (개별 건) |
| EU_STAT | 이유 요약 통계 (1건) |

---

## 2. EU_LIST 컬럼 매핑

| 컬럼 | 설명 | 값/예시 |
|------|------|---------|
| CODE_1 | 개체번호 | FARM_PIG_NO |
| CODE_2 | 이각번호 | IGAK_NO |
| STR_1 | 이유일 | YYYYMMDD |
| STR_2 | 분만일 | YYYYMMDD |
| CNT_1 | 산차 | 0, 1, 2, ... |
| CNT_2 | 이유두수 | DUSU + DUSU_SU |
| CNT_3 | 부분이유두수 | 포유기간 중 자돈이동 |
| CNT_4 | 실산 | TB_BUNMAN.SILSAN |
| CNT_5 | 포유개시 | 실산 - 생시도태 + 지입 - 지출 |
| CNT_6 | 포유기간 | 이유일 - 분만일 |
| VAL_1 | 평균체중 | TOTAL_KG / 이유두수 |

### 부분이유두수 계산

```sql
-- 포유기간 중 자돈이동 합계
SELECT SUM(NVL(DUSU,0)+NVL(DUSU_SU,0))
FROM TB_MODON_JADON_TRANS
WHERE FARM_NO = :farm_no AND PIG_NO = :pig_no
  AND SANCHA = :sancha
  AND GUBUN_CD IN ('160003', '160004', '160001', '160002')
  AND WK_DT BETWEEN :bm_dt AND :eu_dt
  AND USE_YN = 'Y'
```

### 자돈이동 구분코드 (TB_MODON_JADON_TRANS.GUBUN_CD)

| 코드 | 설명 |
|------|------|
| 160001 | 생시도태 |
| 160002 | 폐사 |
| 160003 | 지입 (양자입양) |
| 160004 | 지출 (양자보냄) |

---

## 3. EU_STAT 컬럼 매핑

| 컬럼 | 설명 | 비고 |
|------|------|------|
| CNT_1 | 이유복수 (실적) | 총 이유 건수 |
| CNT_2 | 이유두수 합계 | 전체 이유두수 |
| CNT_3 | 부분이유두수 합계 | 전체 부분이유두수 |
| CNT_4 | 실산 합계 | 전체 실산수 |
| CNT_5 | 포유개시 합계 | 전체 포유개시두수 |
| CNT_6 | 이유복수 (예정) | FN_MD_SCHEDULE_BSE_2020 |
| VAL_1 | 이유두수 평균 | AVG(CNT_2) |
| VAL_2 | 부분이유두수 평균 | AVG(CNT_3) |
| VAL_3 | 평균체중 | 가중평균 (SUM(체중*두수)/SUM(두수)) |
| VAL_4 | 이유육성율 | 이유두수/실산 * 100 |
| VAL_5 | 평균 포유기간 | AVG(CNT_6) |

### 예정 데이터 조회 (FN_MD_SCHEDULE_BSE_2020)

```sql
-- 이유예정 조회 (P_SCHEDULE_GB='150003')
SELECT COUNT(*)
FROM TABLE(FN_MD_SCHEDULE_BSE_2020(
    P_FARM_NO,           -- 농장번호
    'JOB-DAJANG',        -- 리포트 구분
    '150003',            -- 이유예정
    NULL,                -- 모돈상태 (전체)
    P_SDT,               -- 시작일 (yyyy-MM-dd)
    P_EDT,               -- 종료일 (yyyy-MM-dd)
    NULL,                -- 모돈그룹
    'ko',                -- 언어
    'yyyy-MM-dd',        -- 날짜포맷
    '-1',                -- SEQ (-1=전체)
    NULL                 -- 산차범위
));
```

---

## 4. 통계 계산 로직

### 이유육성율 (VAL_4)

```sql
-- 이유두수 / 실산 * 100
ROUND(V_SUM_EUDUSU / V_SUM_SILSAN * 100, 1)
```

### 평균체중 (VAL_3)

가중평균 사용 (두수를 가중치로):

```sql
-- SUM(개별체중 * 개별두수) / SUM(두수)
ROUND(SUM(VAL_1 * CNT_2) / SUM(CNT_2), 2)
```

### 포유개시두수 (CNT_5)

```sql
-- 실산 - 생시도태 + 지입 - 지출 (분만일 기준)
SILSAN
- SUM(생시도태)  -- GUBUN_CD='160001'
+ SUM(지입)      -- GUBUN_CD='160003'
- SUM(지출)      -- GUBUN_CD='160004'
```

---

## 5. TS_INS_WEEK 업데이트

| 컬럼 | 값 | 설명 |
|------|-----|------|
| LAST_EU_CNT | V_TOTAL_CNT | 이유복수 |
| LAST_EU_JD_CNT | V_SUM_EUDUSU | 이유두수 합계 |
| LAST_EU_AVG_KG | V_AVG_KG | 평균체중 |
| LAST_EU_SUM_CNT | V_ACC_EU_CNT | 누적 이유복수 |
| LAST_EU_SUM_JD | V_ACC_EU_JD | 누적 이유두수 |

---

## 6. 프론트엔드 매핑

### WeaningPopupData → EU_STAT

```typescript
interface WeaningPopupData {
  planned: number;              // CNT_6 (이유복수 예정)
  actual: number;               // CNT_1 (이유복수 실적)
  rate: string;                 // actual/planned * 100
  stats: {
    totalWean: { sum: number; avg: number };     // CNT_2, VAL_1 (총 이유두수)
    weanPigs: { sum: number; avg: number };      // CNT_2, VAL_1 (이유두수)
    partialWean: { sum: number; avg: number };   // CNT_3, VAL_2 (부분이유두수)
    avgWeight: { avg: number };                  // VAL_3 (평균체중)
    survivalRate: { rate: string };              // VAL_4 (이유육성율)
    nursingPeriod: { avg: number };              // VAL_5 (평균 포유기간)
  };
}
```

---

## SQL 참조

- [23_SP_INS_WEEK_EU_POPUP.sql](../../sql/ins/week/23_SP_INS_WEEK_EU_POPUP.sql)
